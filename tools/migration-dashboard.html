<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>TDS RapidInt - API Management Dashboard</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        /* Migration Dashboard - Page-specific styles */

        /* Controls row layout */
        .controls-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group:last-of-type {
            flex: 1;
        }

        .filter-group:last-of-type input {
            width: 100%;
        }

        .controls-row button {
            flex-shrink: 0;
        }

        /* Filter labels and inputs now use shared-styles.css .form-label, .form-input, and .form-select */
        /* Dropdown option styling is also in shared-styles.css */

        /* Pagination initially hidden */
        #org-pagination {
            display: none;
        }

        /* Status badges - migration specific */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-legacy {
            background: rgba(75, 85, 99, 0.15);
            color: var(--color-gray-400);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }

        .status-dual {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning-light);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-migrated {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-success-light);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-issues {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-error-light);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-provider-current,
        .status-provider-auto {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning-light);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-provider-salesforce {
            background: rgba(59, 130, 246, 0.15);
            color: var(--color-info-light);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* Progress bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-success {
            background: var(--color-success);
        }

        .progress-warning {
            background: var(--color-warning);
        }

        .progress-danger {
            background: var(--color-error);
        }

        /* Metric scores */
        .metric-score {
            font-weight: 600;
        }

        .metric-score.excellent {
            color: var(--color-success);
        }

        .metric-score.good {
            color: var(--color-success-light);
        }

        .metric-score.fair {
            color: var(--color-warning);
        }

        .metric-score.poor {
            color: var(--color-error);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Detail rows for modals */
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .detail-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Main tab navigation - migration specific */
        .main-tabs {
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-sm);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
        }

        .main-tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 30px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .main-tab:hover:not(.tab-active) {
            background: var(--glass-bg-light);
            color: var(--text-primary);
        }

        .main-tab.tab-active,
        .main-tab.active {
            background: var(--glass-bg-medium);
            color: var(--text-primary);
            border-color: var(--glass-border);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-glass);
        }

        .main-tab-content {
            display: none;
            animation: fade-in var(--transition-base);
        }

        .main-tab-content.tab-content-active,
        .main-tab-content.active {
            display: block;
        }

        /* Endpoint tabs */
        .endpoint-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--glass-border);
            flex-wrap: wrap;
        }

        .endpoint-tab {
            padding: 12px 24px;
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .endpoint-tab:not(.disabled):hover {
            background: var(--glass-bg-medium);
            border-color: var(--glass-border-heavy);
            color: var(--text-primary);
        }

        .endpoint-tab.active {
            background: var(--glass-bg-medium);
            border-color: var(--glass-border-heavy);
            color: var(--text-primary);
        }

        .endpoint-tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .endpoint-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.2);
        }

        .endpoint-content {
            display: none;
        }

        .endpoint-content.active {
            display: block;
        }

        /* Mapping tabs */
        .mapping-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--glass-border);
            flex-wrap: wrap;
        }

        .mapping-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: -2px;
        }

        .mapping-tab:hover {
            color: var(--text-primary);
        }

        .mapping-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--color-white);
        }

        .mapping-content {
            min-height: 300px;
        }

        /* Mapping table */
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .mapping-table th {
            background: var(--glass-bg-light);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--glass-border);
        }

        .mapping-table td {
            padding: 12px;
            border-bottom: 1px solid var(--glass-border);
            vertical-align: top;
        }

        .mapping-table tr:hover {
            background: var(--glass-bg-light);
        }

        .field-name {
            font-family: var(--font-mono);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .api-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .api-badge.legacy {
            background: rgba(75, 85, 99, 0.15);
            color: var(--color-gray-400);
        }

        .api-badge.salesforce {
            background: rgba(59, 130, 246, 0.15);
            color: var(--color-info-light);
        }

        .transformation-note {
            color: var(--color-warning-light);
            font-size: 12px;
            margin-top: 4px;
        }

        .difference-card {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--color-warning);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: var(--radius-md);
        }

        .difference-card h4 {
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .difference-card p {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-column {
            background: var(--glass-bg-light);
            padding: 20px;
            border-radius: var(--radius-md);
        }

        .comparison-column h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Environment toggle */
        .environment-toggle {
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-sm);
            border-radius: var(--radius-xl);
            margin-bottom: 20px;
        }

        .env-tab {
            flex: 1;
            padding: 10px 24px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            transition: all var(--transition-fast);
            font-size: 14px;
        }

        .env-tab:hover {
            background: var(--glass-bg-light);
            border-color: var(--glass-border-heavy);
        }

        .env-tab.active {
            background: var(--glass-bg-medium);
            color: var(--text-primary);
            border-color: var(--glass-border-heavy);
            box-shadow: var(--shadow-glass);
        }

        /* Organization form */
        .org-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .org-form-card {
            background: var(--glass-bg-light);
            border-radius: var(--radius-md);
            padding: 25px;
        }

        .org-form-card h3,
        .org-form-card h4 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 18px;
        }

        .form-group input[readonly] {
            background: rgba(255, 255, 255, 0.05);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Button sizes now use .btn-sm from shared-styles.css */

        /* Result messages now use .alert classes from shared-styles.css */
        .org-result-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .org-result-message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--color-success);
            color: var(--color-success-light);
        }

        .org-result-message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-error);
            color: var(--color-error-light);
        }

        /* Edit modal */
        .edit-org-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
        }

        .edit-org-modal-content {
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(40px);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
        }

        .edit-org-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid var(--glass-border);
        }

        .edit-org-modal-header h3 {
            color: var(--text-primary);
            font-size: 20px;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .edit-org-modal-body {
            padding: 25px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px 25px;
            border-top: 1px solid var(--glass-border);
        }

        /* Organization mapping table */
        .org-mapping-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .org-mapping-table th {
            background: var(--glass-bg-light);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--glass-border);
        }

        .org-mapping-table td {
            padding: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .org-mapping-table tr:hover {
            background: var(--glass-bg-light);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Section header and section-title now in shared-styles.css */

        /* Generic table styles now in shared-styles.css */

        /* Subtitle now uses .header-subtitle from shared-styles.css */

        @media (max-width: 768px) {
            .org-form-grid,
            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }
        }
    </style>
    <!-- XSS Protection: Safe DOM Rendering Utility (HIGH-004 Fix) -->
    <script src="safe-render.js"></script>
</head>
<body>
    <div class="container">
        <div class="header glass card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <img src="tds-rapidint-logo-white.svg" alt="TDS RapidInt Logo" style="height: 50px; width: auto; opacity: 0.95; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));" />
                        <h1 style="color: var(--text-primary); font-weight: 700; background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">API Management Dashboard</h1>
                    </div>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="goBackToHub()" style="background: var(--glass-hover); color: var(--text-primary); border: 1px solid var(--glass-border); padding: 10px 20px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(20px);">
                        ← Back to Integration Hub
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <div class="main-tabs glass card">
            <button class="main-tab active" onclick="showMainTab('organizations')">Organizations</button>
            <button class="main-tab" onclick="showMainTab('mapping')">API Data Mapping</button>
            <button class="main-tab" onclick="showMainTab('settings')">Settings</button>
        </div>

        <!-- Organizations Tab Content -->
        <div id="organizationsTab" class="main-tab-content active">

        <div class="controls glass card">
            <div class="controls-row">
                <div class="filter-group">
                    <label for="statusFilter" class="form-label">TDS Provider:</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">All</option>
                        <option value="current">Legacy</option>
                        <option value="salesforce">Salesforce</option>
                        <option value="auto">Both</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="searchInput" class="form-label">Search:</label>
                    <input type="text" id="searchInput" class="form-input" placeholder="Organization name or agency ref...">
                </div>

                <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
                <button class="btn btn-success" onclick="showAddOrganizationModal()">Add New Organization</button>
            </div>
        </div>

        <div id="errorContainer"></div>

        <!-- Environment Toggle -->
        <div class="environment-toggle glass card">
            <button class="env-tab active" onclick="switchEnvironment('development')">Development</button>
            <button class="env-tab" onclick="switchEnvironment('production')">Production</button>
        </div>

        <div class="organizations-grid glass card">
            <div class="section-header">
                <h2 class="section-title">Organizations</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label style="color: var(--text-primary); font-size: 14px;">Results per page:</label>
                    <select id="org-results-per-page" onchange="changeOrgPageSize()" class="form-select" style="width: auto; padding: 6px 10px; font-size: 14px;">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>

            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <p>Loading organizations...</p>
            </div>

            <div id="tableContainer" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Organization Name</th>
                            <th>Integration Type</th>
                            <th>Legacy Member ID</th>
                            <th>Legacy Branch ID</th>
                            <th>SF Member ID</th>
                            <th>SF Branch ID</th>
                            <th>SF Auth Method</th>
                            <th>Provider Preference</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="organizationsTable">
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div id="org-pagination" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="color: var(--text-secondary); font-size: 14px;">
                    <span id="org-showing-info">Showing 0 - 0 of 0 entries</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn btn-secondary btn-sm" onclick="goToOrgPage(1)" id="org-first-page">First</button>
                    <button class="btn btn-secondary btn-sm" onclick="previousOrgPage()" id="org-prev-page">Previous</button>
                    <span style="color: var(--text-primary); font-size: 14px; padding: 0 10px;">
                        Page <span id="org-current-page">1</span> of <span id="org-total-pages">1</span>
                    </span>
                    <button class="btn btn-secondary btn-sm" onclick="nextOrgPage()" id="org-next-page">Next</button>
                    <button class="btn btn-secondary btn-sm" onclick="goToOrgPage('last')" id="org-last-page">Last</button>
                </div>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon"></div>
                <h3>Database Not Configured</h3>
                <p>To enable API migration tracking, please complete the following setup:</p>
                <ol style="text-align: left; max-width: 600px; margin: 20px auto;">
                    <li>Run database migration scripts (001, 002, 003)</li>
                    <li>Configure SQL_CONNECTION_STRING in local.settings.json</li>
                    <li>Insert organization mappings with credentials</li>
                    <li>Process deposits in dual-mode to generate comparison data</li>
                </ol>
                <p style="margin-top: 20px; color: var(--text-secondary);">
                    <strong>Status:</strong> No organizations in database yet. The dashboard will populate automatically once organizations are added.
                </p>
            </div>
        </div>

        </div> <!-- End Organizations Tab -->

        <!-- API Data Mapping Tab Content -->
        <div id="mappingTab" class="main-tab-content">
            <div class="mapping-section glass card">
                <div class="section-header">
                    <h2 class="section-title">API Data Mapping</h2>
                    <p class="header-subtitle">Field mappings between Legacy TDS API and Salesforce EWC API</p>
                </div>

                <!-- Endpoint Selection Tabs -->
                <div class="endpoint-tabs">
                    <button class="endpoint-tab active" onclick="showEndpointMapping('deposit-creation')">
                        Deposit Creation
                        <span class="endpoint-badge">Active</span>
                    </button>
                    <button class="endpoint-tab disabled" onclick="showEndpointMapping('status-check')" disabled>
                        Status Check
                        <span class="endpoint-badge coming-soon">Coming Soon</span>
                    </button>
                    <button class="endpoint-tab disabled" onclick="showEndpointMapping('deposit-update')" disabled>
                        Deposit Update
                        <span class="endpoint-badge coming-soon">Coming Soon</span>
                    </button>
                </div>

                <!-- Deposit Creation Mapping Content -->
                <div id="depositCreationMapping" class="endpoint-content active">
                    <div class="mapping-tabs">
                        <button class="mapping-tab active" onclick="showMappingTab('overview')">Overview</button>
                        <button class="mapping-tab" onclick="showMappingTab('tenancy')">Tenancy Fields</button>
                        <button class="mapping-tab" onclick="showMappingTab('property')">Property Fields</button>
                        <button class="mapping-tab" onclick="showMappingTab('people')">People Fields</button>
                        <button class="mapping-tab" onclick="showMappingTab('differences')">Key Differences</button>
                    </div>

                    <div id="mappingContent" class="mapping-content">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Status Check Mapping Content (Placeholder) -->
                <div id="statusCheckMapping" class="endpoint-content">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>Status Check Mapping</h3>
                        <p>Field mappings for status check endpoint will be added here.</p>
                    </div>
                </div>

                <!-- Deposit Update Mapping Content (Placeholder) -->
                <div id="depositUpdateMapping" class="endpoint-content">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>Deposit Update Mapping</h3>
                        <p>Field mappings for deposit update endpoint will be added here.</p>
                    </div>
                </div>
            </div>
        </div> <!-- End Mapping Tab -->

        <!-- Settings Tab Content -->
        <div id="settingsTab" class="main-tab-content">
            <!-- Title Section -->
            <div class="glass card" style="margin-bottom: 20px; padding: 20px;">
                <div class="section-header" style="margin-bottom: 0;">
                    <h2 class="section-title">TDS API Configuration</h2>
                    <p style="color: var(--text-primary); margin: 5px 0 0 0; font-size: 14px;">Configure shared TDS API endpoints for all integrations</p>
                </div>
            </div>

            <!-- Settings Form -->
            <div class="glass card">
                <!-- Development Environment Section -->
                <div style="padding: 25px; border-radius: 8px; margin-bottom: 30px; background: var(--glass-bg-light); border: 1px solid var(--glass-border); border-left: 4px solid #667eea;">
                    <h4 style="color: var(--text-primary); margin-bottom: 20px; font-size: 16px; font-weight: 600;">Development Environment</h4>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500; font-size: 14px;">
                            Legacy TDS API Base URL
                        </label>
                        <input
                            type="url"
                            id="settings-dev-legacy-tds"
                            placeholder="https://api-uat.tenancydepositscheme.com"
                            style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px; font-size: 13px;">
                            Current/Legacy TDS API endpoint for development/UAT environment
                        </small>
                    </div>

                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500; font-size: 14px;">
                            Salesforce TDS API Base URL
                        </label>
                        <input
                            type="url"
                            id="settings-dev-sf-tds"
                            placeholder="https://thedisputeservice--fullcopy.sandbox.my.salesforce.com"
                            value="https://thedisputeservice--fullcopy.sandbox.my.salesforce.com"
                            style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px; font-size: 13px;">
                            Salesforce TDS API endpoint (Fullcopy sandbox) for development
                        </small>
                    </div>
                </div>

                <!-- Production Environment Section -->
                <div style="padding: 25px; border-radius: 8px; margin-bottom: 30px; background: var(--glass-bg-light); border: 1px solid var(--glass-border); border-left: 4px solid #48bb78;">
                    <h4 style="color: var(--text-primary); margin-bottom: 20px; font-size: 16px; font-weight: 600;">Production Environment</h4>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500; font-size: 14px;">
                            Legacy TDS API Base URL
                        </label>
                        <input
                            type="url"
                            id="settings-prod-legacy-tds"
                            placeholder="https://api.tenancydepositscheme.com"
                            style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px; font-size: 13px;">
                            Current/Legacy TDS API endpoint for production environment
                        </small>
                    </div>

                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500; font-size: 14px;">
                            Salesforce TDS API Base URL
                        </label>
                        <input
                            type="url"
                            id="settings-prod-sf-tds"
                            placeholder="https://thedisputeservice.my.salesforce.com"
                            style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px; font-size: 13px;">
                            Salesforce TDS API endpoint for production environment
                        </small>
                    </div>
                </div>

                <!-- Save Button -->
                <div style="padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <button class="btn btn-primary" onclick="saveTDSSettings()">
                        Save TDS Configuration
                    </button>
                </div>

                <div id="tds-settings-result" style="margin-top: 20px;"></div>
            </div>
        </div> <!-- End Settings Tab -->

    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Organization Details</div>
            <div class="modal-body" id="modalBody">
                <!-- Details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="actionModalTitle">Confirm Action</div>
            <div class="modal-body" id="actionModalBody">
                <!-- Action confirmation will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeActionModal()">Cancel</button>
                <button class="btn-success" id="confirmActionBtn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:7071/api'; // Update this to your Azure Function URL

        let organizations = [];
        let filteredOrganizations = [];
        let currentAction = null;

        // Pagination variables
        let orgCurrentPage = 1;
        let orgPageSize = 10;
        let orgTotalEntries = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', applyFilters);
        }

        async function loadData() {
            showLoading();
            hideError();

            try {
                // In a real implementation, this would call your Azure Function API
                // For now, we'll use mock data
                const data = await fetchOrganizations();
                organizations = data;
                updateStats(data);
                renderTable(data);
                hideLoading();
            } catch (error) {
                showError('Failed to load organizations: ' + error.message);
                hideLoading();
            }
        }

        async function fetchOrganizations() {
            try {
                // Fetch all organizations and filter by current environment
                const response = await fetch(`${API_BASE_URL}/organization/list`);
                if (!response.ok) {
                    throw new Error('Failed to fetch organizations');
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch organizations');
                }

                // Filter by current environment
                const filteredData = data.mappings.filter(org =>
                    org.environment === currentEnvironment
                );

                return filteredData;
            } catch (error) {
                console.error('Error fetching organizations:', error);
                // Return empty array to show empty state
                return [];
            }
        }

        function updateStats(data) {
            // Stats removed - placeholder for future metrics
        }

        function renderTable(data) {
            const tbody = document.getElementById('organizationsTable');
            tbody.innerHTML = '';

            if (data.length === 0) {
                showEmptyState();
                document.getElementById('org-pagination').style.display = 'none';
                return;
            }

            hideEmptyState();
            document.getElementById('org-pagination').style.display = 'flex';

            // Store filtered data
            filteredOrganizations = data;
            orgTotalEntries = data.length;

            // Calculate pagination
            const totalPages = Math.ceil(orgTotalEntries / orgPageSize) || 1;

            // Ensure current page is valid
            if (orgCurrentPage > totalPages) {
                orgCurrentPage = totalPages;
            }

            const startIndex = (orgCurrentPage - 1) * orgPageSize;
            const endIndex = Math.min(startIndex + orgPageSize, orgTotalEntries);
            const pageEntries = data.slice(startIndex, endIndex);

            // Render only the current page entries
            pageEntries.forEach((org, index) => {
                const actualIndex = startIndex + index; // Calculate actual index in full array
                const row = createTableRow(org, actualIndex);
                tbody.appendChild(row);
            });

            // Update pagination UI
            updateOrgPaginationUI(totalPages, startIndex, endIndex);
        }

        function createTableRow(org, index) {
            const tr = document.createElement('tr');

            // Parse integrationCredentials if it's a JSON string
            let integrationCreds = {};
            if (typeof org.integrationCredentials === 'string') {
                try {
                    integrationCreds = JSON.parse(org.integrationCredentials);
                } catch (e) {
                    console.error('Failed to parse integrationCredentials:', e);
                }
            } else if (typeof org.integrationCredentials === 'object') {
                integrationCreds = org.integrationCredentials;
            }

            // Determine status based on isActive
            const status = org.isActive ? 'active' : 'inactive';

            // ✅ SECURE: Build row using safe DOM methods (HIGH-004 fix)

            // Organization name and environment cell (CRITICAL: User data - must be escaped)
            const orgCell = document.createElement('td');
            const nameDiv = document.createElement('div');
            nameDiv.style.fontWeight = '600';
            nameDiv.style.color = 'var(--text-primary)';
            nameDiv.textContent = org.organizationName || 'N/A'; // ✅ Safely escaped
            const envDiv = document.createElement('div');
            envDiv.style.fontSize = '12px';
            envDiv.style.color = 'var(--text-secondary)';
            envDiv.textContent = org.environment || 'N/A'; // ✅ Safely escaped
            orgCell.appendChild(nameDiv);
            orgCell.appendChild(envDiv);
            tr.appendChild(orgCell);

            // Helper to create simple text cell
            const createTextCell = (text, styles = {}) => {
                const cell = document.createElement('td');
                Object.assign(cell.style, styles);
                cell.textContent = text || 'N/A';
                return cell;
            };

            // Integration type cell
            tr.appendChild(createTextCell(org.integrationType, { fontSize: '12px' }));

            // Legacy member ID cell
            tr.appendChild(createTextCell(org.legacyMemberId, { fontSize: '12px', fontFamily: 'monospace' }));

            // Legacy branch ID cell
            tr.appendChild(createTextCell(org.legacyBranchId, { fontSize: '12px', fontFamily: 'monospace' }));

            // SF member ID cell
            tr.appendChild(createTextCell(org.sfMemberId, { fontSize: '12px', fontFamily: 'monospace' }));

            // SF branch ID cell
            tr.appendChild(createTextCell(org.sfBranchId, { fontSize: '12px', fontFamily: 'monospace' }));

            // SF auth method cell
            tr.appendChild(createTextCell(org.sfAuthMethod, { fontSize: '12px' }));

            // Provider preference cell
            const providerCell = document.createElement('td');
            const providerBadge = document.createElement('span');
            providerBadge.className = `status-badge status-provider-${org.tdsProviderPreference || 'current'}`;
            providerBadge.textContent = getProviderLabel(org.tdsProviderPreference || 'current');
            providerCell.appendChild(providerBadge);
            tr.appendChild(providerCell);

            // Active status cell
            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = `status-badge status-${status}`;
            statusBadge.textContent = org.isActive ? 'Active' : 'Inactive';
            statusCell.appendChild(statusBadge);
            tr.appendChild(statusCell);

            // Actions cell
            const actionsCell = document.createElement('td');
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'action-buttons';
            // ✅ XSS Protection: getActionButtons now returns DOM elements
            actionsDiv.appendChild(getActionButtons(org, index));
            actionsCell.appendChild(actionsDiv);
            tr.appendChild(actionsCell);

            return tr;
        }

        function getStatusLabel(status) {
            const labels = {
                'legacy': 'Legacy',
                'dual': 'Dual Mode',
                'migrated': 'Migrated',
                'issues': 'Issues'
            };
            return labels[status] || status;
        }

        function getProviderLabel(provider) {
            const labels = {
                'current': 'Legacy',
                'salesforce': 'Salesforce',
                'auto': 'Dual Mode'
            };
            return labels[provider] || provider;
        }

        function getScoreClass(score) {
            if (score >= 99) return 'excellent';
            if (score >= 95) return 'good';
            if (score >= 90) return 'fair';
            return 'poor';
        }

        function getResponseTimeClass(time) {
            if (time <= 500) return 'excellent';
            if (time <= 1000) return 'good';
            if (time <= 2000) return 'fair';
            return 'poor';
        }

        function getDifferenceClass(rate) {
            if (rate <= 1) return 'excellent';
            if (rate <= 3) return 'good';
            if (rate <= 5) return 'fair';
            return 'poor';
        }

        function getReadinessClass(score) {
            if (score >= 90) return 'excellent';
            if (score >= 80) return 'good';
            if (score >= 70) return 'fair';
            return 'poor';
        }

        function getProgressClass(value) {
            if (value >= 95) return 'progress-success';
            if (value >= 90) return 'progress-warning';
            return 'progress-danger';
        }

        function getReadinessProgressClass(score) {
            if (score >= 90) return 'progress-success';
            if (score >= 70) return 'progress-warning';
            return 'progress-danger';
        }

        // ✅ XSS Protection: Return DOM elements instead of HTML strings
        function getActionButtons(org, index) {
            const container = document.createDocumentFragment();

            // Edit button
            const editBtn = document.createElement('button');
            editBtn.className = 'icon-btn';
            editBtn.title = 'Edit';
            editBtn.onclick = () => editOrganizationMappingByIndex(index);
            editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11.5 2.5l2 2L6 12H4v-2l7.5-7.5z" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 4l2 2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
            container.appendChild(editBtn);

            // Delete button (store data in dataset instead of inline onclick)
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'icon-btn';
            deleteBtn.title = 'Delete';
            deleteBtn.onclick = () => deleteOrganizationMapping(
                org.organizationName || '',
                org.environment || '',
                org.integrationType || ''
            );
            deleteBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 4h12M5.5 4V2.5A1.5 1.5 0 0 1 7 1h2a1.5 1.5 0 0 1 1.5 1.5V4m2 0v10a1.5 1.5 0 0 1-1.5 1.5h-7A1.5 1.5 0 0 1 2.5 14V4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6.5 7.5v4M9.5 7.5v4" stroke-linecap="round"/>
            </svg>`;
            container.appendChild(deleteBtn);

            return container;
        }

        function editOrganizationMappingByIndex(index) {
            const org = organizations[index];
            if (org) {
                editOrganizationMapping(org, index);
            } else {
                console.error('Organization not found at index:', index);
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter')?.value;
            const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';

            let filtered = organizations;

            // Filter by TDS Provider Preference
            if (statusFilter) {
                filtered = filtered.filter(o => o.tdsProviderPreference === statusFilter);
            }

            // Search by organization name or integration type
            if (searchTerm) {
                filtered = filtered.filter(o =>
                    (o.organizationName && o.organizationName.toLowerCase().includes(searchTerm)) ||
                    (o.integrationType && o.integrationType.toLowerCase().includes(searchTerm)) ||
                    (o.legacyMemberId && o.legacyMemberId.toLowerCase().includes(searchTerm)) ||
                    (o.sfMemberId && o.sfMemberId.toLowerCase().includes(searchTerm))
                );
            }

            // Reset to page 1 when filters change
            orgCurrentPage = 1;
            renderTable(filtered);
        }

        function refreshData() {
            loadData();
        }

        function viewDetails(agencyRef) {
            const org = organizations.find(o => o.agencyRef === agencyRef);
            if (!org) return;

            const successRate = org.totalRequests > 0
                ? ((org.successfulRequests / org.totalRequests) * 100).toFixed(2)
                : 0;

            const differenceRate = org.totalRequests > 0
                ? ((org.requestsWithDifferences / org.totalRequests) * 100).toFixed(2)
                : 0;

            document.getElementById('modalTitle').textContent = org.organizationName;
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Agency Reference:</span>
                    <span class="detail-value">${org.agencyRef}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Provider Preference:</span>
                    <span class="detail-value">${org.providerPreference}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">${getStatusLabel(org.status)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Requests:</span>
                    <span class="detail-value">${org.totalRequests}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Successful Requests:</span>
                    <span class="detail-value">${org.successfulRequests} (${successRate}%)</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Failed Requests:</span>
                    <span class="detail-value">${org.totalRequests - org.successfulRequests}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Requests with Differences:</span>
                    <span class="detail-value">${org.requestsWithDifferences} (${differenceRate}%)</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Avg Response Time:</span>
                    <span class="detail-value">${org.avgResponseTime}ms</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Readiness Score:</span>
                    <span class="detail-value">${org.readinessScore}/100</span>
                </div>
            `;

            document.getElementById('detailsModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        function enableDualMode(agencyRef) {
            const org = organizations.find(o => o.agencyRef === agencyRef);
            currentAction = { type: 'enable-dual', agencyRef, org };

            document.getElementById('actionModalTitle').textContent = 'Enable Dual Mode';
            document.getElementById('actionModalBody').innerHTML = `
                <p>Are you sure you want to enable dual-mode execution for <strong>${org.organizationName}</strong>?</p>
                <p style="margin-top: 15px; color: var(--text-secondary);">This will:</p>
                <ul style="margin-left: 20px; color: var(--text-secondary);">
                    <li>Execute all requests on both Legacy and Salesforce APIs</li>
                    <li>Compare responses and log differences</li>
                    <li>Allow you to monitor migration readiness</li>
                </ul>
            `;

            document.getElementById('actionModal').classList.add('active');
        }

        function migrateOrganization(agencyRef) {
            const org = organizations.find(o => o.agencyRef === agencyRef);
            currentAction = { type: 'migrate', agencyRef, org };

            document.getElementById('actionModalTitle').textContent = 'Migrate to Salesforce API';
            document.getElementById('actionModalBody').innerHTML = `
                <p>Are you sure you want to migrate <strong>${org.organizationName}</strong> to Salesforce API?</p>
                <p style="margin-top: 15px; color: var(--text-secondary);">Readiness Score: <strong>${org.readinessScore}/100</strong></p>
                <p style="margin-top: 15px; color: var(--text-secondary);">This will:</p>
                <ul style="margin-left: 20px; color: var(--text-secondary);">
                    <li>Switch organization to Salesforce-only mode</li>
                    <li>Stop executing requests on Legacy API</li>
                    <li>Log the migration event</li>
                </ul>
            `;

            document.getElementById('confirmActionBtn').className = 'btn-success';
            document.getElementById('actionModal').classList.add('active');
        }

        function rollbackOrganization(agencyRef) {
            const org = organizations.find(o => o.agencyRef === agencyRef);
            currentAction = { type: 'rollback', agencyRef, org };

            document.getElementById('actionModalTitle').textContent = 'Rollback to Legacy API';
            document.getElementById('actionModalBody').innerHTML = `
                <p>Are you sure you want to rollback <strong>${org.organizationName}</strong> to Legacy API?</p>
                <p style="margin-top: 15px; color: var(--color-error-light);">WARNING: This will immediately stop using Salesforce API for this organization.</p>
            `;

            document.getElementById('confirmActionBtn').className = 'btn-danger';
            document.getElementById('actionModal').classList.add('active');
        }

        async function confirmAction() {
            if (!currentAction) return;

            try {
                // In real implementation, call your API endpoint
                // Example: await fetch(`${API_BASE_URL}/organizations/${currentAction.agencyRef}/provider`, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ action: currentAction.type })
                // });

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));

                closeActionModal();

                // Show success message
                alert(`Action "${currentAction.type}" completed successfully for ${currentAction.org.organizationName}`);

                // Refresh data
                refreshData();
            } catch (error) {
                alert('Failed to perform action: ' + error.message);
            }
        }

        function closeActionModal() {
            document.getElementById('actionModal').classList.remove('active');
            currentAction = null;
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
        }

        function showEmptyState() {
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function hideEmptyState() {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
        }

        // ✅ XSS Protection: Use safe DOM creation for error messages
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '';
            const errorDiv = safeCreateElement('div', message, { className: 'error-message' });
            errorContainer.appendChild(errorDiv);
        }

        function hideError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
                currentAction = null;
            }
        }

        // Main Tab Navigation
        function goBackToHub() {
            window.location.href = 'multi-integration-dashboard.html';
        }

        function showMainTab(tabName) {
            // Update active main tab
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'organizations') {
                document.getElementById('organizationsTab').classList.add('active');
            } else if (tabName === 'mapping') {
                document.getElementById('mappingTab').classList.add('active');
            } else if (tabName === 'settings') {
                document.getElementById('settingsTab').classList.add('active');
            }
        }

        // Endpoint Mapping Navigation
        function showEndpointMapping(endpointName) {
            // Don't proceed if disabled
            if (event.target.disabled || event.target.closest('.endpoint-tab').disabled) {
                return;
            }

            // Update active endpoint tab
            document.querySelectorAll('.endpoint-tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.endpoint-tab').classList.add('active');

            // Show/hide endpoint content
            document.querySelectorAll('.endpoint-content').forEach(content => {
                content.classList.remove('active');
            });

            const contentMap = {
                'deposit-creation': 'depositCreationMapping',
                'status-check': 'statusCheckMapping',
                'deposit-update': 'depositUpdateMapping'
            };

            const contentId = contentMap[endpointName];
            if (contentId) {
                document.getElementById(contentId).classList.add('active');
            }
        }

        // API Mapping Functions
        function showMappingTab(tabName) {
            // Update active tab
            document.querySelectorAll('.mapping-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Get content
            const content = getMappingContent(tabName);
            document.getElementById('mappingContent').innerHTML = content;
        }

        function getMappingContent(tabName) {
            switch(tabName) {
                case 'overview':
                    return getOverviewContent();
                case 'tenancy':
                    return getTenancyFieldsContent();
                case 'property':
                    return getPropertyFieldsContent();
                case 'people':
                    return getPeopleFieldsContent();
                case 'differences':
                    return getDifferencesContent();
                default:
                    return '';
            }
        }

        function getOverviewContent() {
            return `
                <h3 style="margin-bottom: 20px;">API Transformation Overview</h3>
                <div class="comparison-grid">
                    <div class="comparison-column">
                        <h3><span class="api-badge legacy">Legacy</span> TDS Custodial API v1.2</h3>
                        <ul style="line-height: 2;">
                            <li><strong>Date Format:</strong> DD/MM/YYYY (slashes)</li>
                            <li><strong>Booleans:</strong> "Y" / "N" (strings)</li>
                            <li><strong>Numbers:</strong> Native numbers (1500)</li>
                            <li><strong>Structure:</strong> tenancy as <code>array</code></li>
                            <li><strong>Auth:</strong> Root level fields</li>
                            <li><strong>Tenant Types:</strong> "Lead Tenant", "Joint Tenant"</li>
                        </ul>
                    </div>
                    <div class="comparison-column">
                        <h3><span class="api-badge salesforce">Salesforce</span> EWC API</h3>
                        <ul style="line-height: 2;">
                            <li><strong>Date Format:</strong> DD-MM-YYYY (dashes)</li>
                            <li><strong>Booleans:</strong> "true" / "false" (strings)</li>
                            <li><strong>Numbers:</strong> String numbers ("1500")</li>
                            <li><strong>Structure:</strong> tenancy as <code>object</code></li>
                            <li><strong>Auth:</strong> AccessToken header</li>
                            <li><strong>Tenant Types:</strong> All "Tenant" (no distinction)</li>
                        </ul>
                    </div>
                </div>

                <div class="difference-card" style="margin-top: 30px;">
                    <h4>WARNING: Critical Transformation Rules</h4>
                    <p>• All numeric values must be converted to strings for Salesforce<br>
                    • Date separators must change from / to -<br>
                    • Boolean values map: Y→"true", N→"false"<br>
                    • Tenant classification flattened in Salesforce<br>
                    • Authentication moved from body to header</p>
                </div>
            `;
        }

        function getTenancyFieldsContent() {
            return `
                <h3 style="margin-bottom: 20px;">Tenancy & Financial Fields</h3>
                <table class="mapping-table">
                    <thead>
                        <tr>
                            <th>Alto/Internal Field</th>
                            <th>Legacy API</th>
                            <th>Salesforce API</th>
                            <th>Transformation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code class="field-name">tenancyId</code></td>
                            <td><code class="field-name">user_tenancy_reference</code></td>
                            <td><code class="field-name">user_tenancy_reference</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">tenancyStartDate</code></td>
                            <td><code class="field-name">tenancy_start_date</code></td>
                            <td><code class="field-name">tenancy_start_date</code></td>
                            <td><span class="transformation-note">ISO → DD/MM/YYYY (Legacy)<br>ISO → DD-MM-YYYY (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">tenancyEndDate</code></td>
                            <td><code class="field-name">tenancy_expected_end_date</code></td>
                            <td><code class="field-name">tenancy_expected_end_date</code></td>
                            <td><span class="transformation-note">ISO → DD/MM/YYYY (Legacy)<br>ISO → DD-MM-YYYY (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">rentAmount</code></td>
                            <td><code class="field-name">rent_amount</code></td>
                            <td><code class="field-name">rent_amount</code></td>
                            <td><span class="transformation-note">Number (Legacy)<br>String "1500" (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">depositAmount</code></td>
                            <td><code class="field-name">deposit_amount</code></td>
                            <td><code class="field-name">deposit_amount</code></td>
                            <td><span class="transformation-note">Number (Legacy)<br>String "2000" (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">amountToProtect</code></td>
                            <td><code class="field-name">deposit_amount_to_protect</code></td>
                            <td><code class="field-name">deposit_amount_to_protect</code></td>
                            <td><span class="transformation-note">Number (Legacy)<br>String "1800" (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">tenants.length</code></td>
                            <td><code class="field-name">number_of_tenants</code></td>
                            <td><code class="field-name">number_of_tenants</code></td>
                            <td><span class="transformation-note">Number (Legacy)<br>String "2" (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">landlords.length</code></td>
                            <td><code class="field-name">number_of_landlords</code></td>
                            <td><code class="field-name">number_of_landlords</code></td>
                            <td><span class="transformation-note">Number (Legacy)<br>String "1" (Salesforce)</span></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function getPropertyFieldsContent() {
            return `
                <h3 style="margin-bottom: 20px;">Property Address & Details</h3>
                <table class="mapping-table">
                    <thead>
                        <tr>
                            <th>Alto/Internal Field</th>
                            <th>Legacy API</th>
                            <th>Salesforce API</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code class="field-name">property.id</code></td>
                            <td><code class="field-name">property_id</code></td>
                            <td><code class="field-name">property_id</code></td>
                            <td>Number → String (SF)</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.address.nameNo</code></td>
                            <td><code class="field-name">property_paon</code></td>
                            <td><code class="field-name">property_paon</code></td>
                            <td>Building name/number</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.address.subDwelling</code></td>
                            <td><code class="field-name">property_saon</code></td>
                            <td><code class="field-name">property_saon</code></td>
                            <td>Flat/Unit number</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.address.street</code></td>
                            <td><code class="field-name">property_street</code></td>
                            <td><code class="field-name">property_street</code></td>
                            <td>Street name</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.address.locality</code></td>
                            <td><code class="field-name">property_locality</code></td>
                            <td><span class="transformation-note">Not in Salesforce</span></td>
                            <td>WARNING: Property locality not supported - use property_town instead</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.address.town</code></td>
                            <td><code class="field-name">property_town</code></td>
                            <td><code class="field-name">property_town</code></td>
                            <td>Town/City</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.county</code></td>
                            <td><code class="field-name">property_administrative_area</code></td>
                            <td><code class="field-name">property_administrative_area</code></td>
                            <td>County/Region</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.address.postcode</code></td>
                            <td><code class="field-name">property_postcode</code></td>
                            <td><code class="field-name">property_postcode</code></td>
                            <td>UK postcode</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.bedrooms</code></td>
                            <td><code class="field-name">number_of_bedrooms</code></td>
                            <td><code class="field-name">number_of_bedrooms</code></td>
                            <td><span class="transformation-note">Number (Legacy)<br>String "3" (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.receptions</code></td>
                            <td><code class="field-name">number_of_living_rooms</code></td>
                            <td><code class="field-name">number_of_living_rooms</code></td>
                            <td><span class="transformation-note">Number (Legacy)<br>String "1" (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">property.furnishedStatus</code></td>
                            <td><code class="field-name">furnished_status</code></td>
                            <td><code class="field-name">furnished_status</code></td>
                            <td><span class="transformation-note">WARNING: DIFFERENT SEMANTICS!<br>Legacy: "furnished"/"part furnished"/"unfurnished"<br>Salesforce: "true"/"false"</span></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function getPeopleFieldsContent() {
            return `
                <h3 style="margin-bottom: 20px;">People (Tenants & Landlords)</h3>

                <div class="difference-card">
                    <h4>Person Classification Mapping</h4>
                    <p><strong>Legacy API:</strong> "Lead Tenant" (first tenant) | "Joint Tenant" (additional tenants)<br>
                    <strong>Salesforce API:</strong> "Tenant" (all tenants, no distinction)<br>
                    <strong>Both APIs:</strong> "Primary Landlord" | "Joint Landlord" (same)</p>
                </div>

                <table class="mapping-table">
                    <thead>
                        <tr>
                            <th>Alto/Internal Field</th>
                            <th>Legacy API</th>
                            <th>Salesforce API</th>
                            <th>Transformation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code class="field-name">person.title</code></td>
                            <td><code class="field-name">person_title</code></td>
                            <td><code class="field-name">person_title</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.firstName</code></td>
                            <td><code class="field-name">person_firstname</code></td>
                            <td><code class="field-name">person_firstname</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.lastName</code></td>
                            <td><code class="field-name">person_surname</code></td>
                            <td><code class="field-name">person_surname</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.isBusiness</code></td>
                            <td><code class="field-name">is_business</code></td>
                            <td><code class="field-name">is_business</code></td>
                            <td><span class="transformation-note">Boolean → "Y"/"N" (Legacy)<br>Boolean → "true"/"false" (Salesforce)</span></td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.businessName</code></td>
                            <td><code class="field-name">business_name</code></td>
                            <td><code class="field-name">business_name</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.email</code></td>
                            <td><code class="field-name">person_email</code></td>
                            <td><code class="field-name">person_email</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.phone</code></td>
                            <td><code class="field-name">person_phone</code></td>
                            <td><code class="field-name">person_phone</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.mobile</code></td>
                            <td><code class="field-name">person_mobile</code></td>
                            <td><code class="field-name">person_mobile</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td colspan="4" style="background: #f7fafc; text-align: center; font-weight: 600;">Person Address Fields</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.address.nameNo</code></td>
                            <td><code class="field-name">person_paon</code></td>
                            <td><code class="field-name">person_paon</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.address.street</code></td>
                            <td><code class="field-name">person_street</code></td>
                            <td><code class="field-name">person_street</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.address.locality</code></td>
                            <td><code class="field-name">person_locality</code></td>
                            <td><code class="field-name">person_locality</code></td>
                            <td>String → String (Supported for people)</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.address.town</code></td>
                            <td><code class="field-name">person_town</code></td>
                            <td><code class="field-name">person_town</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.address.postcode</code></td>
                            <td><code class="field-name">person_postcode</code></td>
                            <td><code class="field-name">person_postcode</code></td>
                            <td>String → String</td>
                        </tr>
                        <tr>
                            <td><code class="field-name">person.address.country</code></td>
                            <td><code class="field-name">person_country</code></td>
                            <td><code class="field-name">person_country</code></td>
                            <td>String → String</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function getDifferencesContent() {
            return `
                <h3 style="margin-bottom: 20px;">Critical API Differences</h3>

                <div class="difference-card">
                    <h4>1. Structure Difference</h4>
                    <p><strong>Legacy API:</strong> <code>tenancy</code> is an <strong>array</strong> [{ ... }]</p>
                    <p><strong>Salesforce API:</strong> <code>tenancy</code> is an <strong>object</strong> { ... }</p>
                </div>

                <div class="difference-card">
                    <h4>2. Authentication Location</h4>
                    <p><strong>Legacy API:</strong> <code>member_id</code>, <code>branch_id</code>, <code>api_key</code> at root level</p>
                    <p><strong>Salesforce API:</strong> All credentials in <code>AccessToken</code> header<br>
                    Format: <code>England & Wales Custodial-Custodial-{memberId}-{branchId}-{apiKey}</code></p>
                </div>

                <div class="difference-card">
                    <h4>3. Data Type Conversion</h4>
                    <table style="width: 100%; margin-top: 10px;">
                        <tr>
                            <th style="text-align: left; padding: 5px;">Type</th>
                            <th style="text-align: left; padding: 5px;">Legacy</th>
                            <th style="text-align: left; padding: 5px;">Salesforce</th>
                        </tr>
                        <tr>
                            <td style="padding: 5px;">Numbers</td>
                            <td style="padding: 5px;"><code>1500</code></td>
                            <td style="padding: 5px;"><code>"1500"</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;">Booleans</td>
                            <td style="padding: 5px;"><code>"Y"</code> / <code>"N"</code></td>
                            <td style="padding: 5px;"><code>"true"</code> / <code>"false"</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 5px;">Dates</td>
                            <td style="padding: 5px;"><code>01/02/2025</code></td>
                            <td style="padding: 5px;"><code>01-02-2025</code></td>
                        </tr>
                    </table>
                </div>

                <div class="difference-card">
                    <h4>4. Furnished Status (WARNING: Major Semantic Difference)</h4>
                    <p><strong>Legacy API:</strong> <code>"furnished"</code>, <code>"part furnished"</code>, <code>"unfurnished"</code> (descriptive strings)</p>
                    <p><strong>Salesforce API:</strong> <code>"true"</code> or <code>"false"</code> (boolean as string)</p>
                    <p style="margin-top: 10px; color: var(--color-error);"><strong>WARNING:</strong> This is a semantic mismatch. You must decide how to map:</p>
                    <ul style="margin-top: 5px;">
                        <li>"furnished" → "true"?</li>
                        <li>"part furnished" → "true"?</li>
                        <li>"unfurnished" → "false"?</li>
                    </ul>
                </div>

                <div class="difference-card">
                    <h4>5. Person Classification</h4>
                    <p><strong>Legacy API:</strong> Distinguishes between <code>"Lead Tenant"</code> and <code>"Joint Tenant"</code></p>
                    <p><strong>Salesforce API:</strong> All tenants are just <code>"Tenant"</code> (no lead distinction)</p>
                </div>

                <div class="difference-card">
                    <h4>6. Response Format</h4>
                    <p><strong>Legacy API:</strong> <code>{ "success": true, "batch_id": "167237" }</code></p>
                    <p><strong>Salesforce API:</strong> <code>{ "Success": "true", "batch_id": "ERR-04238" }</code></p>
                    <p style="margin-top: 10px;">Note: Capitalized "Success" and string boolean value</p>
                </div>

                <div class="difference-card">
                    <h4>7. Asynchronous Processing</h4>
                    <p><strong>Legacy API:</strong> Returns DAN immediately on success</p>
                    <p><strong>Salesforce API:</strong> Returns batch_id, then poll <code>/CreateDepositStatus/{batch_id}</code> for DAN</p>
                </div>

                <div class="difference-card">
                    <h4>8. Missing Fields in Salesforce</h4>
                    <ul>
                        <li><code>property_locality</code> - NOT supported for property address (use <code>property_town</code>)</li>
                        <li><code>person_locality</code> - IS supported for person addresses</li>
                        <li><code>invoice</code> flag - Not supported</li>
                        <li><code>product_type</code> - Not supported</li>
                        <li><code>members_own_reference</code> - Not supported</li>
                    </ul>
                </div>

                <div class="difference-card">
                    <h4>9. Boolean Casing (Minor Note)</h4>
                    <p>Salesforce accepts both <code>"true"</code>/<code>"false"</code> and <code>"TRUE"</code>/<code>"FALSE"</code> (case-insensitive)</p>
                    <p><strong>Recommendation:</strong> Use lowercase <code>"true"</code>/<code>"false"</code> for consistency</p>
                    <p style="margin-top: 10px;">Both work: <code>"is_business": "true"</code> or <code>"is_business": "TRUE"</code></p>
                </div>
            `;
        }

        // Organization Management Functions
        function showAddOrganizationModal() {
            const modal = document.createElement('div');
            modal.className = 'edit-org-modal';
            modal.innerHTML = `
                <div class="edit-org-modal-content" style="max-width: 800px;">
                    <div class="edit-org-modal-header">
                        <h3>Add New Organization Mapping</h3>
                        <button class="close-modal" onclick="this.closest('.edit-org-modal').remove()">&times;</button>
                    </div>
                    <div class="edit-org-modal-body">
                        <!-- Organization Details -->
                        <h4 style="color: var(--text-primary); margin-bottom: 15px; font-size: 16px;">Organization Details</h4>
                        <div class="form-group">
                            <label class="form-label">Organization Name *</label>
                            <input class="form-input" type="text" id="add-organizationName" placeholder="e.g., Demo Estate Agency">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Environment *</label>
                            <select class="form-select" id="add-environment">
                                <option value="development">Development</option>
                                <option value="production">Production</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Integration Type *</label>
                            <select class="form-select" id="add-integrationType" onchange="toggleIntegrationFields('add')">
                                <option value="alto">Alto</option>
                                <option value="jupix">Jupix (Coming Soon)</option>
                            </select>
                        </div>

                        <!-- Integration Credentials -->
                        <h4 style="color: var(--text-primary); margin: 25px 0 15px 0; font-size: 16px;">Integration Credentials</h4>
                        <div id="add-integration-fields">
                            <div class="form-group">
                                <label class="form-label">Alto Agency Reference *</label>
                                <input class="form-input" type="text" id="add-agencyRef" placeholder="e.g., 1af89d60-662c-475b-bcc8-9bcbf04b6322">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alto Branch ID</label>
                                <input class="form-input" type="text" id="add-branchId" placeholder="e.g., MAIN, NORTH, SOUTH (or DEFAULT)">
                            </div>
                        </div>

                        <!-- Legacy TDS Configuration -->
                        <h4 style="color: var(--text-primary); margin: 25px 0 15px 0; font-size: 16px;">Legacy TDS Configuration</h4>
                        <div class="form-group">
                            <label class="form-label">Legacy Member ID *</label>
                            <input class="form-input" type="text" id="add-legacyMemberId" placeholder="e.g., 1960473">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Legacy Branch ID *</label>
                            <input class="form-input" type="text" id="add-legacyBranchId" placeholder="e.g., 1960473">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Legacy API Key *</label>
                            <input class="form-input" type="password" id="add-legacyApiKey" placeholder="Legacy TDS API Key">
                        </div>

                        <!-- Salesforce TDS Configuration -->
                        <h4 style="color: var(--text-primary); margin: 25px 0 15px 0; font-size: 16px;">Salesforce TDS Configuration</h4>
                        <div class="form-group">
                            <label class="form-label">Authentication Method *</label>
                            <select class="form-select" id="add-sfAuthMethod" onchange="toggleSalesforceAuthFields('add')">
                                <option value="api_key">API Key</option>
                                <option value="oauth2">OAuth2 (Client ID & Secret)</option>
                            </select>
                        </div>
                        <div id="add-sf-apikey-fields">
                            <div class="form-group">
                                <label class="form-label">Salesforce API Key *</label>
                                <input class="form-input" type="password" id="add-sfApiKey" placeholder="Salesforce TDS API Key">
                            </div>
                        </div>
                        <div id="add-sf-oauth-fields" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Client ID *</label>
                                <input class="form-input" type="text" id="add-sfClientId" placeholder="Salesforce Client ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Client Secret *</label>
                                <input class="form-input" type="password" id="add-sfClientSecret" placeholder="Salesforce Client Secret">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Salesforce Member ID *</label>
                            <input class="form-input" type="text" id="add-sfMemberId" placeholder="e.g., 1960473">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Salesforce Branch ID *</label>
                            <input class="form-input" type="text" id="add-sfBranchId" placeholder="e.g., 1960473">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Region *</label>
                            <select class="form-select" id="add-sfRegion">
                                <option value="EW">England & Wales</option>
                                <option value="Scotland">Scotland</option>
                                <option value="NI">Northern Ireland</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Scheme Type *</label>
                            <select class="form-select" id="add-sfSchemeType">
                                <option value="Custodial">Custodial</option>
                                <option value="Insured">Insured</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="this.closest('.edit-org-modal').remove()">Cancel</button>
                        <button class="btn btn-success" onclick="addOrganizationMapping()">Add Organization</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('add-organizationName').focus();
        }

        function toggleIntegrationFields(prefix) {
            const integrationType = document.getElementById(`${prefix}-integrationType`).value;
            const fieldsContainer = document.getElementById(`${prefix}-integration-fields`);

            if (integrationType === 'alto') {
                fieldsContainer.innerHTML = `
                    <div class="form-group">
                        <label>Alto Agency Reference *</label>
                        <input type="text" id="${prefix}-agencyRef" placeholder="e.g., 1af89d60-662c-475b-bcc8-9bcbf04b6322">
                    </div>
                    <div class="form-group">
                        <label>Alto Branch ID</label>
                        <input type="text" id="${prefix}-branchId" placeholder="e.g., MAIN, NORTH, SOUTH (or DEFAULT)">
                    </div>
                `;
            } else if (integrationType === 'jupix') {
                fieldsContainer.innerHTML = `
                    <p style="color: var(--text-secondary); font-style: italic;">Jupix integration fields coming soon...</p>
                `;
            }
        }

        function toggleSalesforceAuthFields(prefix) {
            const authMethod = document.getElementById(`${prefix}-sfAuthMethod`).value;
            const apiKeyFields = document.getElementById(`${prefix}-sf-apikey-fields`);
            const oauthFields = document.getElementById(`${prefix}-sf-oauth-fields`);

            if (authMethod === 'api_key') {
                apiKeyFields.style.display = 'block';
                oauthFields.style.display = 'none';
            } else {
                apiKeyFields.style.display = 'none';
                oauthFields.style.display = 'block';
            }
        }

        function toggleEditSalesforceAuthFields() {
            const authMethod = document.getElementById('edit-sfAuthMethod').value;
            const apiKeyFields = document.getElementById('edit-sf-apikey-fields');
            const oauthFields = document.getElementById('edit-sf-oauth-fields');

            if (authMethod === 'api_key') {
                apiKeyFields.style.display = 'block';
                oauthFields.style.display = 'none';
            } else {
                apiKeyFields.style.display = 'none';
                oauthFields.style.display = 'block';
            }
        }

        async function addOrganizationMapping() {
            const integrationType = document.getElementById('add-integrationType').value;
            const sfAuthMethod = document.getElementById('add-sfAuthMethod').value;

            // Build integration credentials
            const integrationCredentials = {};
            if (integrationType === 'alto') {
                integrationCredentials.alto = {
                    agencyRef: document.getElementById('add-agencyRef').value,
                    branchId: document.getElementById('add-branchId').value || 'DEFAULT'
                };
            }

            // Build TDS configurations
            const tdsLegacyConfig = {
                memberId: document.getElementById('add-legacyMemberId').value,
                branchId: document.getElementById('add-legacyBranchId').value,
                apiKey: document.getElementById('add-legacyApiKey').value
            };

            const tdsSalesforceConfig = {
                memberId: document.getElementById('add-sfMemberId').value,
                branchId: document.getElementById('add-sfBranchId').value,
                region: document.getElementById('add-sfRegion').value,
                schemeType: document.getElementById('add-sfSchemeType').value,
                authMethod: sfAuthMethod
            };

            if (sfAuthMethod === 'api_key') {
                tdsSalesforceConfig.apiKey = document.getElementById('add-sfApiKey').value;
            } else {
                tdsSalesforceConfig.clientId = document.getElementById('add-sfClientId').value;
                tdsSalesforceConfig.clientSecret = document.getElementById('add-sfClientSecret').value;
            }

            const data = {
                organizationName: document.getElementById('add-organizationName').value,
                environment: document.getElementById('add-environment').value,
                integrationType: integrationType,
                integrationCredentials: integrationCredentials,
                tdsLegacyConfig: tdsLegacyConfig,
                tdsSalesforceConfig: tdsSalesforceConfig,
                isActive: true
            };

            // Validation
            if (!data.organizationName) {
                alert('Please enter an organization name');
                return;
            }

            if (integrationType === 'alto' && !integrationCredentials.alto.agencyRef) {
                alert('Please enter Alto Agency Reference');
                return;
            }

            if (!tdsLegacyConfig.memberId || !tdsLegacyConfig.branchId || !tdsLegacyConfig.apiKey) {
                alert('Please fill in all Legacy TDS configuration fields');
                return;
            }

            if (!tdsSalesforceConfig.memberId || !tdsSalesforceConfig.branchId) {
                alert('Please fill in all Salesforce TDS configuration fields');
                return;
            }

            if (sfAuthMethod === 'api_key' && !tdsSalesforceConfig.apiKey) {
                alert('Please enter Salesforce API Key');
                return;
            }

            if (sfAuthMethod === 'oauth2' && (!tdsSalesforceConfig.clientId || !tdsSalesforceConfig.clientSecret)) {
                alert('Please enter Salesforce Client ID and Client Secret');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/organization/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Organization mapping added successfully!');
                    document.querySelector('.edit-org-modal').remove();
                    refreshData(); // Refresh the main organizations table
                } else {
                    alert(result.error || 'Failed to add organization mapping');
                }
            } catch (error) {
                console.error('Error adding organization mapping:', error);
                alert('Error adding organization mapping');
            }
        }

        function editOrganizationMapping(org, index) {
            // Parse integrationCredentials if it's a JSON string
            let integrationCreds = {};
            if (typeof org.integrationCredentials === 'string') {
                try {
                    integrationCreds = JSON.parse(org.integrationCredentials);
                } catch (e) {
                    console.error('Failed to parse integrationCredentials:', e);
                }
            } else if (typeof org.integrationCredentials === 'object') {
                integrationCreds = org.integrationCredentials;
            }

            // Extract Alto credentials if present
            const altoAgencyRef = integrationCreds.alto?.agencyRef || '';
            const altoBranchId = integrationCreds.alto?.branchId || 'DEFAULT';

            // Create and show edit modal
            const modal = document.createElement('div');
            modal.className = 'edit-org-modal';
            modal.innerHTML = `
                <div class="edit-org-modal-content" style="max-width: 800px;">
                    <div class="edit-org-modal-header">
                        <h3>Edit Organization Mapping</h3>
                        <button class="close-modal" onclick="this.closest('.edit-org-modal').remove()">&times;</button>
                    </div>
                    <div class="edit-org-modal-body">
                        <!-- Organization Details -->
                        <h4 style="color: var(--text-primary); margin-bottom: 15px; font-size: 16px;">Organization Details</h4>
                        <div class="form-group">
                            <label class="form-label">Organization Name *</label>
                            <input class="form-input" type="text" id="edit-organizationName" value="${org.organizationName || ''}" placeholder="e.g., Demo Estate Agency">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Environment</label>
                            <input class="form-input" type="text" id="edit-environment" value="${org.environment || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Integration Type</label>
                            <input class="form-input" type="text" id="edit-integrationType" value="${org.integrationType || ''}" readonly>
                        </div>

                        <!-- Integration Credentials -->
                        <h4 style="color: var(--text-primary); margin: 25px 0 15px 0; font-size: 16px;">Integration Credentials</h4>
                        <div class="form-group">
                            <label class="form-label">Alto Agency Reference</label>
                            <input class="form-input" type="text" id="edit-agencyRef" value="${altoAgencyRef}" placeholder="e.g., 1af89d60-662c-475b-bcc8-9bcbf04b6322">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alto Branch ID</label>
                            <input class="form-input" type="text" id="edit-branchId" value="${altoBranchId}" placeholder="e.g., MAIN, NORTH, SOUTH (or DEFAULT)">
                        </div>

                        <!-- Legacy TDS Configuration -->
                        <h4 style="color: var(--text-primary); margin: 25px 0 15px 0; font-size: 16px;">Legacy TDS Configuration</h4>
                        <div class="form-group">
                            <label class="form-label">Legacy Member ID *</label>
                            <input class="form-input" type="text" id="edit-legacyMemberId" value="${org.legacyMemberId || ''}" placeholder="e.g., 1960473">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Legacy Branch ID *</label>
                            <input class="form-input" type="text" id="edit-legacyBranchId" value="${org.legacyBranchId || ''}" placeholder="e.g., 1960473">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Legacy API Key *</label>
                            <input class="form-input" type="password" id="edit-legacyApiKey" placeholder="Leave blank to keep existing key">
                        </div>

                        <!-- Salesforce TDS Configuration -->
                        <h4 style="color: var(--text-primary); margin: 25px 0 15px 0; font-size: 16px;">Salesforce TDS Configuration</h4>
                        <div class="form-group">
                            <label class="form-label">Authentication Method *</label>
                            <select class="form-select" id="edit-sfAuthMethod" onchange="toggleEditSalesforceAuthFields()">
                                <option value="api_key" ${org.sfAuthMethod === 'api_key' ? 'selected' : ''}>API Key</option>
                                <option value="oauth2" ${org.sfAuthMethod === 'oauth2' ? 'selected' : ''}>OAuth2 (Client ID & Secret)</option>
                            </select>
                        </div>
                        <div id="edit-sf-apikey-fields">
                            <div class="form-group">
                                <label class="form-label">Salesforce API Key *</label>
                                <input class="form-input" type="password" id="edit-sfApiKey" placeholder="Leave blank to keep existing key">
                            </div>
                        </div>
                        <div id="edit-sf-oauth-fields" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Client ID *</label>
                                <input class="form-input" type="text" id="edit-sfClientId" value="${org.sfClientId || ''}" placeholder="Leave blank to keep existing">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Client Secret *</label>
                                <input class="form-input" type="password" id="edit-sfClientSecret" placeholder="Leave blank to keep existing">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Salesforce Member ID *</label>
                            <input class="form-input" type="text" id="edit-sfMemberId" value="${org.sfMemberId || ''}" placeholder="e.g., 1960473">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Salesforce Branch ID *</label>
                            <input class="form-input" type="text" id="edit-sfBranchId" value="${org.sfBranchId || ''}" placeholder="e.g., 1960473">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Region *</label>
                            <select class="form-select" id="edit-sfRegion">
                                <option value="EW" ${org.sfRegion === 'EW' || org.sfRegion === 'england-and-wales' ? 'selected' : ''}>England & Wales</option>
                                <option value="Scotland" ${org.sfRegion === 'Scotland' || org.sfRegion === 'scotland' ? 'selected' : ''}>Scotland</option>
                                <option value="NI" ${org.sfRegion === 'NI' || org.sfRegion === 'northern-ireland' ? 'selected' : ''}>Northern Ireland</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Scheme Type *</label>
                            <select class="form-select" id="edit-sfSchemeType">
                                <option value="Custodial" ${org.sfSchemeType === 'Custodial' || org.sfSchemeType === 'custodial' ? 'selected' : ''}>Custodial</option>
                                <option value="Insured" ${org.sfSchemeType === 'Insured' || org.sfSchemeType === 'insured' ? 'selected' : ''}>Insured</option>
                            </select>
                        </div>

                        <!-- Additional Settings -->
                        <h4 style="color: var(--text-primary); margin: 25px 0 15px 0; font-size: 16px;">Additional Settings</h4>
                        <div class="form-group">
                            <label class="form-label">TDS Provider Preference</label>
                            <select class="form-select" id="edit-tdsProviderPreference">
                                <option value="current" ${org.tdsProviderPreference === 'current' ? 'selected' : ''}>Legacy Only</option>
                                <option value="salesforce" ${org.tdsProviderPreference === 'salesforce' ? 'selected' : ''}>Salesforce Only</option>
                                <option value="auto" ${org.tdsProviderPreference === 'auto' ? 'selected' : ''}>Auto (Dual Mode)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="edit-isActive">
                                <option value="true" ${org.isActive ? 'selected' : ''}>Active</option>
                                <option value="false" ${!org.isActive ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="this.closest('.edit-org-modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveOrganizationMappingByIndex(${index})">Save Changes</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('edit-organizationName').focus();

            // Initialize auth fields display based on current selection
            toggleEditSalesforceAuthFields();
        }

        function saveOrganizationMappingByIndex(index) {
            const org = organizations[index];
            if (org) {
                saveOrganizationMapping(org.organizationName, org.environment, org.integrationType);
            } else {
                console.error('Organization not found at index:', index);
                alert('Error: Could not find organization to update');
            }
        }

        async function saveOrganizationMapping(organizationName, environment, integrationType) {
            const updatedOrgName = document.getElementById('edit-organizationName').value;
            const agencyRef = document.getElementById('edit-agencyRef')?.value;
            const branchId = document.getElementById('edit-branchId')?.value;
            const legacyMemberId = document.getElementById('edit-legacyMemberId').value;
            const legacyBranchId = document.getElementById('edit-legacyBranchId').value;
            const legacyApiKey = document.getElementById('edit-legacyApiKey').value;
            const sfMemberId = document.getElementById('edit-sfMemberId').value;
            const sfBranchId = document.getElementById('edit-sfBranchId').value;
            const sfRegion = document.getElementById('edit-sfRegion').value;
            const sfSchemeType = document.getElementById('edit-sfSchemeType').value;
            const sfAuthMethod = document.getElementById('edit-sfAuthMethod').value;
            const sfApiKey = document.getElementById('edit-sfApiKey').value;
            const sfClientId = document.getElementById('edit-sfClientId').value;
            const sfClientSecret = document.getElementById('edit-sfClientSecret').value;
            const tdsProviderPreference = document.getElementById('edit-tdsProviderPreference').value;
            const isActive = document.getElementById('edit-isActive').value === 'true';

            if (!updatedOrgName || !legacyMemberId || !legacyBranchId) {
                alert('Please fill in all required fields (Organization Name, Legacy Member ID, Legacy Branch ID)');
                return;
            }

            try {
                const updateData = {
                    organizationName,
                    environment,
                    integrationType,
                    updatedOrganizationName: updatedOrgName,
                    legacyMemberId,
                    legacyBranchId,
                    sfMemberId,
                    sfBranchId,
                    sfRegion,
                    sfSchemeType,
                    sfAuthMethod,
                    tdsProviderPreference,
                    isActive
                };

                // Include integration credentials if present
                if (agencyRef || branchId) {
                    updateData.integrationCredentials = {
                        alto: {
                            agencyRef: agencyRef || '',
                            branchId: branchId || 'DEFAULT'
                        }
                    };
                }

                // Only include keys if they were entered
                if (legacyApiKey.trim()) {
                    updateData.legacyApiKey = legacyApiKey;
                }
                if (sfApiKey.trim()) {
                    updateData.sfApiKey = sfApiKey;
                }
                if (sfClientId.trim()) {
                    updateData.sfClientId = sfClientId;
                }
                if (sfClientSecret.trim()) {
                    updateData.sfClientSecret = sfClientSecret;
                }

                const response = await fetch(`${API_BASE_URL}/organization/update`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Organization mapping updated: ${updatedOrgName}`);
                    document.querySelector('.edit-org-modal').remove();
                    refreshData(); // Refresh the main organizations table
                } else {
                    alert(`Failed to update mapping: ${result.error}`);
                }
            } catch (error) {
                console.error('Error updating organization mapping:', error);
                alert('Error updating organization mapping');
            }
        }

        async function deleteOrganizationMapping(organizationName, environment, integrationType) {
            if (!confirm(`Are you sure you want to delete the organization mapping for "${organizationName}" (${environment} - ${integrationType})?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/organization/delete`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        organizationName,
                        environment,
                        integrationType
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Organization mapping deleted: ${organizationName}`);
                    refreshData(); // Refresh the main organizations table
                } else {
                    alert(`Failed to delete mapping: ${result.error}`);
                }
            } catch (error) {
                console.error('Error deleting organization mapping:', error);
                alert('Error deleting organization mapping');
            }
        }

        // Environment Switching
        let currentEnvironment = 'development';

        function switchEnvironment(environment) {
            currentEnvironment = environment;

            // Update active tab
            document.querySelectorAll('.env-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Refresh data for the selected environment
            refreshData();
        }

        // Initialize mapping on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show default tab
            const mappingContent = document.getElementById('mappingContent');
            if (mappingContent) {
                mappingContent.innerHTML = getOverviewContent();
            }

            // Load TDS settings when page loads
            loadTDSSettings();
        });

        /**
         * Save TDS Settings to Backend
         */
        async function saveTDSSettings() {
            const developmentSettings = {
                legacyTdsApi: document.getElementById('settings-dev-legacy-tds').value,
                salesforceTdsApi: document.getElementById('settings-dev-sf-tds').value
            };

            const productionSettings = {
                legacyTdsApi: document.getElementById('settings-prod-legacy-tds').value,
                salesforceTdsApi: document.getElementById('settings-prod-sf-tds').value
            };

            // Validation
            if (!developmentSettings.salesforceTdsApi || !productionSettings.salesforceTdsApi) {
                showTDSResult({
                    success: false,
                    message: 'Please enter both Development and Production Salesforce TDS API URLs'
                }, 'error');
                return;
            }

            const tdsSettings = {
                development: developmentSettings,
                production: productionSettings,
                savedAt: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE_URL}/settings/tds`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tdsSettings)
                });

                const result = await response.json();

                if (result.success) {
                    showTDSResult({
                        success: true,
                        message: `TDS configuration saved successfully! Last updated: ${new Date(result.lastUpdated).toLocaleString()}`
                    }, 'success');
                } else {
                    showTDSResult(result, 'error');
                }
            } catch (error) {
                console.error('Error saving TDS settings:', error);
                // Fallback to localStorage
                localStorage.setItem('tdsSettings', JSON.stringify(tdsSettings));
                showTDSResult({
                    success: true,
                    message: 'WARNING: Settings saved locally (backend unavailable). Changes will sync when backend is available.'
                }, 'warning');
            }
        }

        /**
         * Load TDS Settings from Backend
         */
        async function loadTDSSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/settings/tds`);
                const result = await response.json();

                if (result.success && result.settings) {
                    const { development, production } = result.settings;

                    // Load development settings
                    document.getElementById('settings-dev-legacy-tds').value = development.legacyTdsApi || '';
                    document.getElementById('settings-dev-sf-tds').value = development.salesforceTdsApi || 'https://thedisputeservice--fullcopy.sandbox.my.salesforce.com';

                    // Load production settings
                    document.getElementById('settings-prod-legacy-tds').value = production.legacyTdsApi || '';
                    document.getElementById('settings-prod-sf-tds').value = production.salesforceTdsApi || '';
                }
            } catch (error) {
                console.error('Error loading TDS settings:', error);
                // Try localStorage fallback
                const localSettings = JSON.parse(localStorage.getItem('tdsSettings') || '{}');
                if (localSettings.development) {
                    document.getElementById('settings-dev-legacy-tds').value = localSettings.development.legacyTdsApi || '';
                    document.getElementById('settings-dev-sf-tds').value = localSettings.development.salesforceTdsApi || 'https://thedisputeservice--fullcopy.sandbox.my.salesforce.com';
                    document.getElementById('settings-prod-legacy-tds').value = localSettings.production.legacyTdsApi || '';
                    document.getElementById('settings-prod-sf-tds').value = localSettings.production.salesforceTdsApi || '';
                }
            }
        }

        /**
         * Show TDS Settings Result
         * ✅ XSS Protection: Uses safe DOM creation
         */
        function showTDSResult(result, type) {
            const resultDiv = document.getElementById('tds-settings-result');

            const bgColors = {
                success: '#d4edda',
                error: '#f8d7da',
                warning: '#fff3cd',
                info: '#d1ecf1'
            };

            const textColors = {
                success: '#155724',
                error: '#721c24',
                warning: '#856404',
                info: '#0c5460'
            };

            // ✅ XSS Protection: Create result container safely
            resultDiv.innerHTML = '';
            const messageDiv = document.createElement('div');
            messageDiv.style.padding = '15px';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.background = bgColors[type] || bgColors.info;
            messageDiv.style.color = textColors[type] || textColors.info;
            messageDiv.style.border = `1px solid ${textColors[type] || textColors.info}20`;
            messageDiv.style.whiteSpace = 'pre-wrap';
            messageDiv.textContent = result.message; // ✅ Safe: textContent auto-escapes
            resultDiv.appendChild(messageDiv);

            // Auto-hide after 5 seconds for success messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 5000);
            }
        }

        // ============================================
        // PAGINATION FUNCTIONS
        // ============================================

        function updateOrgPaginationUI(totalPages, startIndex, endIndex) {
            document.getElementById('org-current-page').textContent = orgCurrentPage;
            document.getElementById('org-total-pages').textContent = totalPages;
            document.getElementById('org-showing-info').textContent =
                `Showing ${startIndex + 1} - ${endIndex} of ${orgTotalEntries} entries`;

            // Enable/disable pagination buttons
            document.getElementById('org-first-page').disabled = orgCurrentPage === 1;
            document.getElementById('org-prev-page').disabled = orgCurrentPage === 1;
            document.getElementById('org-next-page').disabled = orgCurrentPage === totalPages;
            document.getElementById('org-last-page').disabled = orgCurrentPage === totalPages;
        }

        function changeOrgPageSize() {
            orgPageSize = parseInt(document.getElementById('org-results-per-page').value);
            orgCurrentPage = 1; // Reset to first page
            renderTable(filteredOrganizations);
        }

        function nextOrgPage() {
            const totalPages = Math.ceil(orgTotalEntries / orgPageSize);
            if (orgCurrentPage < totalPages) {
                orgCurrentPage++;
                renderTable(filteredOrganizations);
            }
        }

        function previousOrgPage() {
            if (orgCurrentPage > 1) {
                orgCurrentPage--;
                renderTable(filteredOrganizations);
            }
        }

        function goToOrgPage(page) {
            const totalPages = Math.ceil(orgTotalEntries / orgPageSize);

            if (page === 'last') {
                orgCurrentPage = totalPages;
            } else if (page === 1) {
                orgCurrentPage = 1;
            } else {
                orgCurrentPage = Math.max(1, Math.min(page, totalPages));
            }

            renderTable(filteredOrganizations);
        }
    </script>
</body>
</html>
