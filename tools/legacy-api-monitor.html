<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>TDS RapidInt - Legacy to Salesforce Bridge</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        /* Legacy API Monitor - Page-specific styles */

        /* Accordion Styles */
        .accordion {
            margin-bottom: var(--space-md);
        }

        .accordion-item {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-md);
            overflow: hidden;
            backdrop-filter: blur(20px);
            transition: all var(--transition-fast);
        }

        .accordion-item:hover {
            border-color: var(--glass-border-heavy);
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
        }

        .accordion-header:hover {
            background: var(--glass-bg-medium);
        }

        .accordion-header.active {
            background: var(--glass-bg-medium);
            border-bottom: 1px solid var(--glass-border);
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .accordion-status {
            font-size: 0.875rem;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            background: var(--color-success);
            color: white;
        }

        .accordion-status.pending {
            background: var(--color-warning);
        }

        .accordion-icon {
            transition: transform var(--transition-base);
            font-size: 1.2rem;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-base) ease-out;
        }

        .accordion-content.active {
            max-height: 2000px; /* Large enough for content */
        }

        .accordion-body {
            padding: var(--space-lg);
            border-top: 1px solid var(--glass-border);
        }

        /* Workflow Section Styles */
        .workflow-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        @media (max-width: 1024px) {
            .workflow-section {
                grid-template-columns: 1fr;
            }
        }

        .payload-editor {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            backdrop-filter: blur(20px);
        }

        .payload-editor textarea {
            width: 100%;
            min-height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            line-height: 1.5;
            resize: vertical;
            transition: all var(--transition-fast);
        }

        .payload-editor textarea:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--glass-border-heavy);
            outline: none;
        }

        .response-viewer {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            backdrop-filter: blur(20px);
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .response-status {
            padding: 6px 16px;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .response-status.success {
            background: var(--color-success);
            color: white;
        }

        .response-status.error {
            background: var(--color-error);
            color: white;
        }

        .response-content {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .response-content pre {
            margin: 0;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .empty-response {
            color: var(--text-secondary);
            text-align: center;
            padding: var(--space-xl);
            font-style: italic;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            text-align: center;
            backdrop-filter: blur(20px);
            transition: all var(--transition-fast);
        }

        .stat-card:hover {
            background: var(--glass-bg-medium);
            border-color: var(--glass-border-heavy);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
            color: var(--text-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>

    <!-- Microsoft Authentication Library -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

    <!-- Environment-specific configuration (NOT in git) -->
    <script src="dashboard-config.js"></script>
</head>
<body>
    <div class="container">
        <div class="header glass card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);">
                <div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="tds-rapidint-logo-white.svg" alt="TDS RapidInt Logo" style="height: 50px; width: auto; opacity: 0.95; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));" />
                        <h1 style="color: var(--text-primary); font-weight: 700; background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">Legacy to Salesforce Bridge</h1>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: var(--space-md); flex-wrap: wrap;">
                    <span id="gatewayStatus" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--glass-bg-light); border: 1px solid var(--glass-border); border-radius: 20px; backdrop-filter: blur(20px); white-space: nowrap;">
                        <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-gray-400); display: inline-block;"></span>
                        <span>Checking...</span>
                    </span>
                    <button class="btn btn-secondary" onclick="goBackToHub()" style="background: var(--glass-hover); color: var(--text-primary); border: 1px solid var(--glass-border); padding: 10px 20px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(20px); white-space: nowrap;">
                        ‚Üê Back to Integration Hub
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs glass">
            <div class="tab tab-active" onclick="showTab('execute-workflow')">Execute Workflow</div>
            <div class="tab" onclick="showTab('real-time')">Real-Time Activity</div>
            <div class="tab" onclick="showTab('organizations')">Organizations</div>
            <div class="tab" onclick="showTab('endpoints')">Endpoint Coverage</div>
            <div class="tab" onclick="showTab('logs')">Transformation Logs</div>
        </div>

        <!-- Tab 1: Execute Workflow -->
        <div id="execute-workflow" class="tab-content tab-content-active">
            <div class="card glass">
                <h3>Execute Legacy API Workflow</h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">Manually test Legacy API payloads by entering complete request bodies</p>
                    <!-- Organization Selector -->
                    <div class="form-group">
                        <label class="form-label" for="org-selector">Select Organization (Optional)</label>
                        <select id="org-selector" class="form-select" onchange="onOrganizationChange()">
                            <option value="">-- Select an organization --</option>
                        </select>
                        <div class="form-hint">Use "Load Example" to populate payload with selected organization's credentials</div>
                    </div>

                    <!-- Accordion for Endpoints -->
                    <div class="accordion" id="endpoints-accordion">
                        <!-- CreateDeposit Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>CreateDeposit</span>
                                    <span class="accordion-status">Implemented</span>
                                </div>
                                <span class="accordion-icon">‚ñº</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Payload Editor -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Request Payload</h3>
                                            <div class="payload-editor">
                                                <textarea id="createdeposit-payload" placeholder="Paste Legacy API payload here..."></textarea>
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                                                <button class="btn btn-primary" onclick="executeEndpoint('CreateDeposit')">
                                                    Execute CreateDeposit
                                                </button>
                                                <button class="btn btn-secondary" onclick="loadExamplePayload('CreateDeposit')">
                                                    Load Example
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('CreateDeposit')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="createdeposit-response-status"></span>
                                                    <span id="createdeposit-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="createdeposit-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CreateDepositStatus Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>CreateDepositStatus</span>
                                    <span class="accordion-status">Implemented</span>
                                </div>
                                <span class="accordion-icon">‚ñº</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Parameters -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Request Parameters</h3>
                                            <div class="form-group">
                                                <label class="form-label" for="batch-id-input">Batch ID</label>
                                                <input type="text" id="batch-id-input" class="form-input" placeholder="Enter batch_id from CreateDeposit response">
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                                                <button class="btn btn-primary" onclick="executeEndpoint('CreateDepositStatus')">
                                                    Check Status
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('CreateDepositStatus')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="createdepositstatus-response-status"></span>
                                                    <span id="createdepositstatus-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="createdepositstatus-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Future Endpoint Placeholder -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>Future Endpoints</span>
                                    <span class="accordion-status pending">Pending</span>
                                </div>
                                <span class="accordion-icon">‚ñº</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <p style="color: var(--color-gray-400); text-align: center; padding: var(--space-xl);">
                                        Additional Legacy API endpoints will be added here as they are implemented.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>

        <!-- Tab 2: Real-Time Activity -->
        <div id="real-time" class="tab-content">
            <div class="card glass">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                    <h3>Real-Time Activity</h3>
                    <button class="btn btn-secondary btn-sm" onclick="loadRecentRequests()">
                        Refresh
                    </button>
                </div>
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-requests-hour">--</div>
                            <div class="stat-label">Requests (Last Hour)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-success-rate">--</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-avg-response">--</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-active-orgs">--</div>
                            <div class="stat-label">Active Organizations</div>
                        </div>
                    </div>

                    <!-- Recent Requests Table -->
                    <h3 style="margin-bottom: var(--space-md);">Recent Requests</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Organization</th>
                                    <th>Endpoint</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-requests-table">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">
                                        Loading recent requests...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
            </div>
        </div>

        <!-- Tab 3: Organizations -->
        <div id="organizations" class="tab-content">
            <div class="card glass">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                    <h3>Organizations Using Legacy API</h3>
                    <button class="btn btn-secondary btn-sm" onclick="loadOrganizations()">
                        Refresh
                    </button>
                </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Organization Name</th>
                                    <th>Legacy Member ID</th>
                                    <th>Environment</th>
                                    <th>Requests Today</th>
                                    <th>Success Rate</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="organizations-table">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">
                                        Loading organizations...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
            </div>
        </div>

        <!-- Tab 4: Endpoint Coverage -->
        <div id="endpoints" class="tab-content">
            <div class="card glass">
                <h3>Endpoint Coverage</h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">Status of Legacy API endpoint implementations</p>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Legacy Endpoint</th>
                                    <th>Salesforce Endpoint</th>
                                    <th>Status</th>
                                    <th>Transformation</th>
                                    <th>Test Coverage</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>/CreateDeposit</code></td>
                                    <td><code>/services/apexrest/depositcreation</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Tested</td>
                                    <td>Fully operational</td>
                                </tr>
                                <tr>
                                    <td><code>/CreateDepositStatus/{batchId}</code></td>
                                    <td><code>/services/apexrest/CreateDepositStatus/{batchId}</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Tested</td>
                                    <td>Fully operational</td>
                                </tr>
                                <tr>
                                    <td><code>/UpdateTenancy</code></td>
                                    <td><code>/services/apexrest/tenancyupdate</code></td>
                                    <td><span class="badge badge-warning">Pending</span></td>
                                    <td><span class="badge badge-warning">Not Started</span></td>
                                    <td>Not Tested</td>
                                    <td>Awaiting implementation</td>
                                </tr>
                                <tr>
                                    <td><code>/ReleaseDeposit</code></td>
                                    <td><code>/services/apexrest/depositrelease</code></td>
                                    <td><span class="badge badge-warning">Pending</span></td>
                                    <td><span class="badge badge-warning">Not Started</span></td>
                                    <td>Not Tested</td>
                                    <td>Awaiting implementation</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-info" style="margin-top: var(--space-lg);">
                        <strong>Adding New Endpoints:</strong> To add a new Legacy endpoint, update the <code>LegacyAPIGateway.js</code> file with a new route handler and corresponding transformation logic in <code>legacy-to-salesforce.js</code>.
                    </div>
            </div>
        </div>

        <!-- Tab 5: Transformation Logs -->
        <div id="logs" class="tab-content">
            <div class="card glass">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                    <h3>Transformation Logs</h3>
                    <div style="display: flex; gap: var(--space-sm);">
                        <button class="btn btn-secondary btn-sm" onclick="loadTransformationLogs()">
                            Refresh
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="downloadLogs()">
                            Download CSV
                        </button>
                    </div>
                </div>
                    <!-- Filters -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div class="form-group">
                            <label class="form-label">Organization</label>
                            <select id="log-filter-org" class="form-select" onchange="applyLogFilters()">
                                <option value="">All Organizations</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Endpoint</label>
                            <select id="log-filter-endpoint" class="form-select" onchange="applyLogFilters()">
                                <option value="">All Endpoints</option>
                                <option value="CreateDeposit">CreateDeposit</option>
                                <option value="CreateDepositStatus">CreateDepositStatus</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="log-filter-status" class="form-select" onchange="applyLogFilters()">
                                <option value="">All Statuses</option>
                                <option value="success">Success</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Organization</th>
                                    <th>Endpoint</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">
                                        Loading transformation logs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
            </div>
        </div>
    </div> <!-- End Container -->

    <!-- Footer -->
    <footer class="glass card" style="margin: 25px auto 20px auto; max-width: 1400px; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: var(--text-secondary); font-size: 13px;">
            ¬© 2025 TDS RapidInt Platform
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <span id="userInfo" style="color: var(--text-secondary); font-size: 14px;"></span>
            <button class="btn btn-secondary" onclick="signOut()" id="signOutBtn" style="display:none; background: var(--glass-hover); color: var(--text-primary); border: 1px solid var(--glass-border); padding: 8px 16px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(20px); font-size: 13px;">
                Sign Out
            </button>
        </div>
    </footer>

    <script src="safe-render.js"></script>
    <script>
        // Configuration - from dashboard-config.js
        const API_BASE_URL = DASHBOARD_CONFIG.apiBaseUrl;
        const AUTH_METHOD = DASHBOARD_CONFIG.authMethod;

        // MSAL Configuration
        let msalInstance = null;
        let currentUser = null;

        /**
         * Helper function to run code when DOM is ready
         * Works both for initial page load and after redirects
         */
        function runWhenReady(callback) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                // DOM is already loaded, run immediately
                callback();
            }
        }

        if (AUTH_METHOD === 'entra-id') {
            const msalConfig = {
                auth: {
                    clientId: DASHBOARD_CONFIG.entraId.clientId,
                    authority: DASHBOARD_CONFIG.entraId.authority,
                    redirectUri: window.location.origin + window.location.pathname
                },
                cache: {
                    cacheLocation: 'localStorage',
                    storeAuthStateInCookie: false
                }
            };

            msalInstance = new msal.PublicClientApplication(msalConfig);

            // Handle redirect response
            msalInstance.handleRedirectPromise().then(response => {
                if (response) {
                    console.log('‚úÖ Login successful:', response.account.username);
                    currentUser = response.account;
                }
                // Update user info if authenticated
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentUser = accounts[0];
                    document.getElementById('userInfo').textContent = `Welcome, ${currentUser.name || currentUser.username}`;
                    document.getElementById('signOutBtn').style.display = 'block';
                }
            }).catch(error => {
                console.error('‚ùå Authentication error:', error);
            });
        } else {
            // Function key mode (legacy)
            const FUNCTION_KEY = DASHBOARD_CONFIG.functionKey;
        }

        // Global state
        let organizations = [];
        let selectedOrg = null;

        /**
         * Get access token for API calls
         */
        async function getAccessToken() {
            if (AUTH_METHOD !== 'entra-id') {
                return null; // Function key mode
            }

            try {
                const accounts = msalInstance.getAllAccounts();

                if (accounts.length === 0) {
                    // No accounts, redirect to login
                    await msalInstance.loginRedirect({
                        scopes: [DASHBOARD_CONFIG.entraId.apiScope]
                    });
                    return null;
                }

                // Try to acquire token silently
                const silentRequest = {
                    scopes: [DASHBOARD_CONFIG.entraId.apiScope],
                    account: accounts[0]
                };

                const response = await msalInstance.acquireTokenSilent(silentRequest);
                return response.accessToken;
            } catch (error) {
                console.warn('Silent token acquisition failed, trying interactive:', error);

                if (error instanceof msal.InteractionRequiredAuthError) {
                    // Fallback to interactive login
                    await msalInstance.loginRedirect({
                        scopes: [DASHBOARD_CONFIG.entraId.apiScope]
                    });
                } else {
                    console.error('Token acquisition error:', error);
                    throw error;
                }

                return null;
            }
        }

        /**
         * Make authenticated API request
         */
        async function makeAuthenticatedRequest(url, options = {}) {
            if (AUTH_METHOD === 'entra-id') {
                // Entra ID mode - use Bearer token
                const token = await getAccessToken();

                if (!token) {
                    throw new Error('Failed to acquire access token');
                }

                return await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
            } else {
                // Function key mode (legacy)
                const separator = url.includes('?') ? '&' : '?';
                const authenticatedUrl = `${url}${separator}code=${DASHBOARD_CONFIG.functionKey}`;

                return await fetch(authenticatedUrl, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
            }
        }

        /**
         * Sign out user (Entra ID only)
         */
        async function signOut() {
            if (AUTH_METHOD === 'entra-id' && msalInstance) {
                await msalInstance.logoutRedirect();
            }
        }

        /**
         * Navigate back to Integration Hub
         */
        function goBackToHub() {
            window.location.href = 'multi-integration-dashboard.html';
        }

        /**
         * Initialize dashboard
         */
        async function init() {
            console.log('Initializing Legacy API Monitor...');
            await loadOrganizations();
            await checkGatewayHealth();
        }

        /**
         * Check Gateway Health
         */
        async function checkGatewayHealth() {
            const statusElement = document.getElementById('gatewayStatus');

            try {
                const response = await fetch(`${API_BASE_URL}/legacy/health`);
                const data = await response.json();

                if (data.status === 'healthy') {
                    statusElement.innerHTML = `
                        <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-success); display: inline-block;"></span>
                        <span>Gateway Active</span>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-error); display: inline-block;"></span>
                        <span>Gateway Error</span>
                    `;
                }
            } catch (error) {
                console.error('Failed to check gateway health:', error);
                statusElement.innerHTML = `
                    <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-error); display: inline-block;"></span>
                    <span>Gateway Offline</span>
                `;
            }
        }

        /**
         * Load Organizations
         */
        async function loadOrganizations() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/organization/list`);
                const data = await response.json();

                if (data.success) {
                    // Filter organizations with Legacy credentials
                    organizations = data.mappings.filter(org =>
                        org.legacyMemberId && org.legacyBranchId && org.isActive
                    );

                    // Populate organization dropdown
                    const selector = document.getElementById('org-selector');
                    selector.innerHTML = '<option value="">-- Select an organization --</option>';

                    organizations.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.agencyRef;
                        option.textContent = `${org.organizationName} (${org.legacyMemberId}/${org.legacyBranchId})`;
                        selector.appendChild(option);
                    });

                    console.log(`Loaded ${organizations.length} organizations with Legacy credentials`);

                    // Populate organizations table
                    populateOrganizationsTable();
                }
            } catch (error) {
                console.error('Failed to load organizations:', error);
            }
        }

        /**
         * Populate Organizations Table
         */
        function populateOrganizationsTable() {
            const tbody = document.getElementById('organizations-table');
            tbody.innerHTML = '';

            if (organizations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">No organizations found with Legacy API credentials</td></tr>';
                return;
            }

            organizations.forEach(org => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${org.organizationName}</td>
                    <td><code>${org.legacyMemberId}</code></td>
                    <td><span class="badge badge-${org.environment === 'production' ? 'error' : 'info'}">${org.environment}</span></td>
                    <td>--</td>
                    <td>--</td>
                    <td><span class="badge badge-${org.isActive ? 'success' : 'warning'}">${org.isActive ? 'Active' : 'Inactive'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * On Organization Change
         */
        function onOrganizationChange() {
            const agencyRef = document.getElementById('org-selector').value;

            if (!agencyRef) {
                selectedOrg = null;
                return;
            }

            selectedOrg = organizations.find(org => org.agencyRef === agencyRef);

            if (selectedOrg) {
                console.log('Selected organization:', selectedOrg);
                // Organization selected - now you can use "Load Example" to populate with this org's credentials
            }
        }

        /**
         * Toggle Accordion
         */
        function toggleAccordion(headerElement) {
            const content = headerElement.nextElementSibling;
            const isActive = headerElement.classList.contains('active');

            // Close all accordions
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.classList.remove('active');
                header.nextElementSibling.classList.remove('active');
            });

            // Open clicked accordion (if it wasn't already open)
            if (!isActive) {
                headerElement.classList.add('active');
                content.classList.add('active');
            }
        }

        /**
         * Load Example Payload
         */
        function loadExamplePayload(endpoint) {
            if (!selectedOrg) {
                alert('Please select an organization first');
                return;
            }

            let examplePayload;

            if (endpoint === 'CreateDeposit') {
                examplePayload = {
                    member_id: selectedOrg.legacyMemberId,
                    branch_id: selectedOrg.legacyBranchId,
                    api_key: selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE',
                    region: 'EW',
                    scheme_type: 'Custodial',
                    tenancy: [{
                        user_tenancy_reference: 'TEST_TEN_' + Date.now(),
                        property_id: '12345',
                        property_paon: '123',
                        property_saon: 'Flat 4B',
                        property_street: 'Main Street',
                        property_town: 'London',
                        property_administrative_area: 'Greater London',
                        property_postcode: 'SW1A 1AA',
                        tenancy_start_date: '2025-10-15',
                        tenancy_expected_end_date: '2026-10-15',
                        number_of_bedrooms: 2,
                        number_of_living_rooms: 1,
                        furnished_status: 'furnished',
                        rent_amount: 1500.00,
                        deposit_amount: 1500.00,
                        deposit_amount_to_protect: 1500.00,
                        deposit_received_date: '2025-10-15',
                        number_of_tenants: 1,
                        number_of_landlords: 1,
                        people: [
                            {
                                person_classification: 'Lead Tenant',
                                person_title: 'Mr',
                                person_firstname: 'John',
                                person_surname: 'Doe',
                                person_email: 'john.doe@example.com',
                                person_mobile: '07700900123',
                                is_business: 'N'
                            },
                            {
                                person_classification: 'Primary Landlord',
                                person_title: 'Ms',
                                person_firstname: 'Jane',
                                person_surname: 'Smith',
                                person_email: 'jane.smith@example.com',
                                person_mobile: '07700900456',
                                person_paon: '456',
                                person_street: 'Oak Avenue',
                                person_town: 'London',
                                person_postcode: 'SW2A 2BB',
                                person_country: 'United Kingdom',
                                is_business: 'N'
                            }
                        ]
                    }]
                };

                document.getElementById('createdeposit-payload').value = JSON.stringify(examplePayload, null, 2);
            }
        }

        /**
         * Clear Payload
         */
        function clearPayload(endpoint) {
            if (endpoint === 'CreateDeposit') {
                document.getElementById('createdeposit-payload').value = '';
                document.getElementById('createdeposit-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('createdeposit-response-status').innerHTML = '';
                document.getElementById('createdeposit-response-time').innerHTML = '';
            } else if (endpoint === 'CreateDepositStatus') {
                document.getElementById('batch-id-input').value = '';
                document.getElementById('createdepositstatus-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('createdepositstatus-response-status').innerHTML = '';
                document.getElementById('createdepositstatus-response-time').innerHTML = '';
            }
        }

        /**
         * Execute Endpoint
         */
        async function executeEndpoint(endpoint) {
            try {
                if (endpoint === 'CreateDeposit') {
                    await executeCreateDeposit();
                } else if (endpoint === 'CreateDepositStatus') {
                    await executeCreateDepositStatus();
                }
            } catch (error) {
                console.error('Execution failed:', error);
                alert(`Execution failed: ${error.message}`);
            }
        }

        /**
         * Execute CreateDeposit
         */
        async function executeCreateDeposit() {
            const payloadText = document.getElementById('createdeposit-payload').value;

            if (!payloadText.trim()) {
                alert('Please enter a payload or load an example');
                return;
            }

            let payload;
            try {
                payload = JSON.parse(payloadText);
            } catch (e) {
                alert('Invalid JSON payload');
                return;
            }

            // Validate required credentials are present in the payload
            if (!payload.member_id || !payload.branch_id || !payload.api_key) {
                alert('Payload must include member_id, branch_id, and api_key');
                return;
            }

            // Show loading state
            document.getElementById('createdeposit-response').innerHTML = '<div class="empty-response">Executing request...</div>';
            document.getElementById('createdeposit-response-status').innerHTML = '';
            document.getElementById('createdeposit-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                const response = await fetch(`${API_BASE_URL}/legacy/CreateDeposit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                // Check both response.ok (HTTP 200-299) and data.success field
                // Also check for DAN presence as indicator of success
                const isSuccess = response.ok && (data.success === true || data.dan);

                const statusElement = document.getElementById('createdeposit-response-status');
                statusElement.className = `response-status ${isSuccess ? 'success' : 'error'}`;
                statusElement.textContent = isSuccess ? 'Success' : 'Error';

                document.getElementById('createdeposit-response-time').textContent = `${duration}ms`;

                document.getElementById('createdeposit-response').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('createdeposit-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('createdeposit-response-time').textContent = `${duration}ms`;
                document.getElementById('createdeposit-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Execute CreateDepositStatus
         */
        async function executeCreateDepositStatus() {
            const batchId = document.getElementById('batch-id-input').value.trim();

            if (!batchId) {
                alert('Please enter a batch ID');
                return;
            }

            if (!selectedOrg) {
                alert('Please select an organization to check deposit status');
                return;
            }

            // Show loading state
            document.getElementById('createdepositstatus-response').innerHTML = '<div class="empty-response">Checking status...</div>';
            document.getElementById('createdepositstatus-response-status').innerHTML = '';
            document.getElementById('createdepositstatus-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                const response = await fetch(`${API_BASE_URL}/legacy/CreateDepositStatus/${batchId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        member_id: selectedOrg.legacyMemberId,
                        branch_id: selectedOrg.legacyBranchId,
                        api_key: selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE'
                    })
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                const statusElement = document.getElementById('createdepositstatus-response-status');
                statusElement.className = `response-status ${data.error ? 'error' : 'success'}`;
                statusElement.textContent = data.error ? 'Error' : 'Success';

                document.getElementById('createdepositstatus-response-time').textContent = `${duration}ms`;

                document.getElementById('createdepositstatus-response').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('createdepositstatus-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('createdepositstatus-response-time').textContent = `${duration}ms`;
                document.getElementById('createdepositstatus-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Tab Switching
         */
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('tab-content-active'));

            // Highlight the clicked tab
            if (typeof event !== 'undefined' && event && event.target && event.target.classList.contains('tab')) {
                // Normal tab click - highlight the clicked tab
                event.target.classList.add('tab-active');
            } else {
                // Programmatic tab switching - find and highlight the correct tab
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.getAttribute('onclick') === `showTab('${tabName}')`) {
                        tab.classList.add('tab-active');
                    }
                });
            }

            // Show the selected tab content
            document.getElementById(tabName).classList.add('tab-content-active');

            // Load data for specific tabs
            if (tabName === 'real-time') {
                loadRecentRequests();
            } else if (tabName === 'logs') {
                loadTransformationLogs();
            }
        }

        /**
         * Load Recent Requests
         */
        async function loadRecentRequests() {
            const tbody = document.getElementById('recent-requests-table');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">Loading recent requests...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/legacy/activity`);
                const data = await response.json();

                if (data.success) {
                    // Update stats
                    document.getElementById('stat-requests-hour').textContent = data.stats.requestsLastHour;
                    document.getElementById('stat-success-rate').textContent = data.stats.successRate;
                    document.getElementById('stat-avg-response').textContent = data.stats.avgResponseTime;
                    document.getElementById('stat-active-orgs').textContent = data.stats.activeOrgs;

                    // Populate table
                    if (data.batches.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">No recent requests found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = '';
                    data.batches.forEach(batch => {
                        const row = document.createElement('tr');
                        const timestamp = new Date(batch.createdAt).toLocaleString();
                        const status = batch.danNumber ? 'success' : (batch.currentStatus === 'submitted' ? 'pending' : 'failed');
                        const statusBadge = status === 'success' ? 'badge-success' : (status === 'pending' ? 'badge-warning' : 'badge-error');

                        row.innerHTML = `
                            <td>${timestamp}</td>
                            <td>${batch.organizationName || 'Unknown'}</td>
                            <td><code>CreateDeposit</code></td>
                            <td><span class="badge ${statusBadge}">${status}</span></td>
                            <td>${batch.requestDurationMs ? batch.requestDurationMs + 'ms' : '--'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewBatchDetails('${batch.batchId}', '${batch.organizationId}')">
                                    View
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--color-error); padding: var(--space-xl);">Error loading activity: ${data.error}</td></tr>`;
                }
            } catch (error) {
                console.error('Failed to load recent requests:', error);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--color-error); padding: var(--space-xl);">Failed to load activity</td></tr>`;

                // Set default stats
                document.getElementById('stat-requests-hour').textContent = '--';
                document.getElementById('stat-success-rate').textContent = '--';
                document.getElementById('stat-avg-response').textContent = '--';
                document.getElementById('stat-active-orgs').textContent = organizations.length;
            }
        }

        /**
         * View Batch Details (Placeholder)
         */
        function viewBatchDetails(batchId, organizationId) {
            alert(`Batch Details:\nBatch ID: ${batchId}\nOrganization ID: ${organizationId}\n\nDetailed view coming soon...`);
        }

        /**
         * Load Transformation Logs (Placeholder)
         */
        function loadTransformationLogs() {
            const tbody = document.getElementById('logs-table');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">No transformation logs available</td></tr>';
        }

        /**
         * Apply Log Filters (Placeholder)
         */
        function applyLogFilters() {
            console.log('Applying log filters...');
            loadTransformationLogs();
        }

        /**
         * Download Logs (Placeholder)
         */
        function downloadLogs() {
            alert('CSV download functionality coming soon');
        }

        // Initialize on page load
        runWhenReady(init);
    </script>
</body>
</html>
