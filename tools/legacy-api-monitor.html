<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>TDS RapidInt - Legacy to Salesforce Bridge</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        /* Legacy API Monitor - Page-specific styles */

        /* Accordion Styles */
        .accordion {
            margin-bottom: var(--space-md);
        }

        .accordion-item {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-md);
            overflow: hidden;
            backdrop-filter: blur(20px);
            transition: all var(--transition-fast);
        }

        .accordion-item:hover {
            border-color: var(--glass-border-heavy);
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
        }

        .accordion-header:hover {
            background: var(--glass-bg-medium);
        }

        .accordion-header.active {
            background: var(--glass-bg-medium);
            border-bottom: 1px solid var(--glass-border);
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .accordion-status {
            font-size: 0.875rem;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            color: white;
            font-weight: 600;
        }

        /* HTTP Method Badges */
        .accordion-status.method-get {
            background: #3b82f6; /* Blue */
        }

        .accordion-status.method-post {
            background: #10b981; /* Green */
        }

        .accordion-status.method-put {
            background: #8b5cf6; /* Purple */
        }

        .accordion-status.method-delete {
            background: #ef4444; /* Red */
        }

        .accordion-status.pending {
            background: var(--color-warning);
        }

        .accordion-icon {
            transition: transform var(--transition-base);
            font-size: 1.2rem;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-base) ease-out;
        }

        .accordion-content.active {
            max-height: 2000px; /* Large enough for content */
        }

        .accordion-body {
            padding: var(--space-lg);
            border-top: 1px solid var(--glass-border);
        }

        /* Workflow Section Styles */
        .workflow-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        @media (max-width: 1024px) {
            .workflow-section {
                grid-template-columns: 1fr;
            }
        }

        .payload-editor {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            backdrop-filter: blur(20px);
        }

        .payload-editor textarea {
            width: 100%;
            min-height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            line-height: 1.5;
            resize: vertical;
            transition: all var(--transition-fast);
        }

        .payload-editor textarea:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--glass-border-heavy);
            outline: none;
        }

        .response-viewer {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            backdrop-filter: blur(20px);
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .response-status {
            padding: 6px 16px;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .response-status.success {
            background: var(--color-success);
            color: white;
        }

        .response-status.error {
            background: var(--color-error);
            color: white;
        }

        .response-content {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .response-content pre {
            margin: 0;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .empty-response {
            color: var(--text-secondary);
            text-align: center;
            padding: var(--space-xl);
            font-style: italic;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            background: var(--glass-bg-light);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            text-align: center;
            backdrop-filter: blur(20px);
            transition: all var(--transition-fast);
        }

        .stat-card:hover {
            background: var(--glass-bg-medium);
            border-color: var(--glass-border-heavy);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
            color: var(--text-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>

    <!-- Microsoft Authentication Library -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

    <!-- Environment-specific configuration (NOT in git) -->
    <script src="dashboard-config.js"></script>
</head>
<body>
    <div class="container">
        <div class="header glass card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);">
                <div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="tds-rapidint-logo-white.svg" alt="TDS RapidInt Logo" style="height: 50px; width: auto; opacity: 0.95; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));" />
                        <h1 style="color: var(--text-primary); font-weight: 700; background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">Legacy to Salesforce Bridge</h1>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: var(--space-md); flex-wrap: wrap;">
                    <span id="gatewayStatus" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--glass-bg-light); border: 1px solid var(--glass-border); border-radius: 20px; backdrop-filter: blur(20px); white-space: nowrap;">
                        <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-gray-400); display: inline-block;"></span>
                        <span>Checking...</span>
                    </span>
                    <button class="btn btn-secondary" onclick="goBackToHub()" style="background: var(--glass-hover); color: var(--text-primary); border: 1px solid var(--glass-border); padding: 10px 20px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(20px); white-space: nowrap;">
                        ← Back to Integration Hub
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs glass">
            <div class="tab tab-active" onclick="showTab('execute-workflow')">Execute Workflow</div>
            <div class="tab" onclick="showTab('real-time')">Real-Time Activity</div>
            <div class="tab" onclick="showTab('organizations')">Organizations</div>
            <div class="tab" onclick="showTab('endpoints')">Endpoint Coverage</div>
            <div class="tab" onclick="showTab('logs')">Transformation Logs</div>
        </div>

        <!-- Tab 1: Execute Workflow -->
        <div id="execute-workflow" class="tab-content tab-content-active">
            <div class="card glass">
                <h3>Execute Legacy API Workflow</h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">Manually test Legacy API payloads by entering complete request bodies</p>
                    <!-- Organization Selector -->
                    <div class="form-group">
                        <label class="form-label" for="org-selector">Select Organization (Optional)</label>
                        <select id="org-selector" class="form-select" onchange="onOrganizationChange()">
                            <option value="">-- Select an organization --</option>
                        </select>
                        <div class="form-hint">Use "Load Example" to populate payload with selected organization's credentials</div>
                    </div>

                    <!-- Accordion for Endpoints -->
                    <div class="accordion" id="endpoints-accordion">
                        <!-- CreateDeposit Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>CreateDeposit</span>
                                    <span class="accordion-status method-post">POST</span>
                                </div>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Payload Editor -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Request Payload</h3>
                                            <div class="payload-editor">
                                                <textarea id="createdeposit-payload" placeholder="Paste Legacy API payload here..."></textarea>
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                                                <button class="btn btn-primary" onclick="executeEndpoint('CreateDeposit')">
                                                    Execute CreateDeposit
                                                </button>
                                                <button class="btn btn-secondary" onclick="loadExamplePayload('CreateDeposit')">
                                                    Load Example
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('CreateDeposit')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="createdeposit-response-status"></span>
                                                    <span id="createdeposit-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="createdeposit-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CreateDepositStatus Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>CreateDepositStatus</span>
                                    <span class="accordion-status method-get">GET</span>
                                </div>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Parameters -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Request Parameters</h3>
                                            <div class="form-group">
                                                <label class="form-label" for="batch-id-input">Batch ID</label>
                                                <input type="text" id="batch-id-input" class="form-input" placeholder="Enter batch_id from CreateDeposit response">
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                                                <button class="btn btn-primary" onclick="executeEndpoint('CreateDepositStatus')">
                                                    Check Status
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('CreateDepositStatus')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="createdepositstatus-response-status"></span>
                                                    <span id="createdepositstatus-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="createdepositstatus-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TenancyInformation Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>TenancyInformation</span>
                                    <span class="accordion-status method-get">GET</span>
                                </div>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Parameters -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Request Parameters</h3>
                                            <div class="form-group">
                                                <label class="form-label" for="dan-input">DAN (Deposit Account Number)</label>
                                                <input type="text" id="dan-input" class="form-input" placeholder="e.g., EW0232232 or NI0000123">
                                                <div class="form-hint">Enter the Deposit Account Number to retrieve tenancy information</div>
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                                                <button class="btn btn-primary" onclick="executeEndpoint('TenancyInformation')">
                                                    Get Tenancy Info
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('TenancyInformation')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="tenancyinformation-response-status"></span>
                                                    <span id="tenancyinformation-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="tenancyinformation-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Landlords Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>Landlords</span>
                                    <span class="accordion-status method-get">GET</span>
                                </div>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Parameters -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Search Filters</h3>
                                            <div class="form-group">
                                                <label class="form-label" for="landlord-id-input">Landlord ID</label>
                                                <input type="text" id="landlord-id-input" class="form-input" placeholder="e.g., 123456">
                                                <div class="form-hint">Search by landlord ID</div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" for="landlord-email-input">Email</label>
                                                <input type="text" id="landlord-email-input" class="form-input" placeholder="e.g., landlord@example.com">
                                                <div class="form-hint">Search by email address</div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" for="landlord-limit-input">Limit</label>
                                                <input type="number" id="landlord-limit-input" class="form-input" placeholder="50" value="50">
                                                <div class="form-hint">Maximum number of results (default 50)</div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" for="landlord-after-id-input">After ID (Pagination)</label>
                                                <input type="text" id="landlord-after-id-input" class="form-input" placeholder="e.g., 123456">
                                                <div class="form-hint">For pagination - last ID from previous batch</div>
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                                                <button class="btn btn-primary" onclick="executeEndpoint('Landlords')">
                                                    Search Landlords
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('Landlords')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="landlords-response-status"></span>
                                                    <span id="landlords-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="landlords-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Properties Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>Properties</span>
                                    <span class="accordion-status method-get">GET</span>
                                </div>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Parameters -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Search Filters</h3>
                                            <div class="form-group">
                                                <label class="form-label" for="property-id-input">Property ID</label>
                                                <input type="text" id="property-id-input" class="form-input" placeholder="e.g., 123456">
                                                <div class="form-hint">Search by property ID</div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" for="property-postcode-input">Postcode</label>
                                                <input type="text" id="property-postcode-input" class="form-input" placeholder="e.g., HP2 7TG">
                                                <div class="form-hint">Search by postcode</div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" for="property-limit-input">Limit</label>
                                                <input type="number" id="property-limit-input" class="form-input" placeholder="50" value="50">
                                                <div class="form-hint">Maximum number of results (default 50)</div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" for="property-after-id-input">After ID (Pagination)</label>
                                                <input type="text" id="property-after-id-input" class="form-input" placeholder="e.g., 123456">
                                                <div class="form-hint">For pagination - last ID from previous batch</div>
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                                                <button class="btn btn-primary" onclick="executeEndpoint('Properties')">
                                                    Search Properties
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('Properties')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="properties-response-status"></span>
                                                    <span id="properties-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="properties-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RaiseRepaymentRequest Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>RaiseRepaymentRequest</span>
                                    <span class="accordion-status method-post">POST</span>
                                </div>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Payload -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Request Payload</h3>
                                            <div class="form-group">
                                                <label class="form-label">JSON Payload</label>
                                                <textarea id="raiserepaymentrequest-payload" class="form-textarea" rows="20"
                                                          placeholder="Enter JSON payload or load an example..."></textarea>
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm); flex-wrap: wrap;">
                                                <button class="btn btn-primary" onclick="executeEndpoint('RaiseRepaymentRequest')">
                                                    Submit Repayment Request
                                                </button>
                                                <button class="btn btn-secondary" onclick="loadExamplePayload('RaiseRepaymentRequest')">
                                                    Load Example
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('RaiseRepaymentRequest')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="raiserepaymentrequest-response-status"></span>
                                                    <span id="raiserepaymentrequest-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="raiserepaymentrequest-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- DPC (Deposit Protection Certificate) Endpoint -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>DPC (Deposit Protection Certificate)</span>
                                    <span class="accordion-status method-get">GET</span>
                                </div>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <div class="workflow-section">
                                        <!-- Request Parameters -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Request Parameters</h3>
                                            <div class="form-group">
                                                <label class="form-label" for="dpc-dan-input">DAN (Deposit Account Number)</label>
                                                <input type="text" id="dpc-dan-input" class="form-input" placeholder="e.g., EW0232232 or NI0000123">
                                                <div class="form-hint">Enter the Deposit Account Number to retrieve the DPC certificate</div>
                                            </div>
                                            <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm);">
                                                <button class="btn btn-primary" onclick="executeEndpoint('DPC')">
                                                    Get Certificate
                                                </button>
                                                <button class="btn btn-secondary" onclick="clearPayload('DPC')">
                                                    Clear
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Response Viewer -->
                                        <div>
                                            <h3 style="margin-bottom: var(--space-md);">Response</h3>
                                            <div class="response-viewer">
                                                <div class="response-header">
                                                    <span id="dpc-response-status"></span>
                                                    <span id="dpc-response-time" style="color: var(--color-gray-400); font-size: 0.875rem;"></span>
                                                </div>
                                                <div class="response-content" id="dpc-response">
                                                    <div class="empty-response">Response will appear here after execution</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Future Endpoints -->
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-title">
                                    <span>Future Endpoints</span>
                                    <span class="accordion-status pending">Pending</span>
                                </div>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div class="accordion-body">
                                    <h3 style="margin-bottom: var(--space-md);">Planned Endpoints</h3>
                                    <p style="color: var(--color-gray-400); margin-bottom: var(--space-lg);">
                                        The following endpoints from the Legacy TDS API are not yet available because their Salesforce equivalents do not currently exist:
                                    </p>

                                    <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                                        <!-- Create Head Office Branch -->
                                        <div style="padding: var(--space-md); border: 1px solid var(--color-gray-700); border-radius: 6px; background: rgba(255, 255, 255, 0.02);">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                                                <h4 style="margin: 0; color: var(--color-gray-200);">Create Head Office Branch</h4>
                                                <span class="badge badge-warning">Blocked</span>
                                            </div>
                                            <p style="color: var(--color-gray-400); margin: var(--space-xs) 0; font-size: 0.875rem;">
                                                <strong>Method:</strong> PUT
                                            </p>
                                            <p style="color: var(--color-gray-400); margin: var(--space-xs) 0; font-size: 0.875rem;">
                                                <strong>Legacy Endpoint:</strong> <code>/headOffices/{head_office_member_id}/branches</code>
                                            </p>
                                            <p style="color: var(--color-gray-400); margin: var(--space-xs) 0; font-size: 0.875rem;">
                                                <strong>Description:</strong> Create a new branch under a head office
                                            </p>
                                            <p style="color: var(--color-gray-500); margin: var(--space-xs) 0; font-size: 0.813rem; font-style: italic;">
                                                <strong>Status:</strong> Awaiting Salesforce API implementation
                                            </p>
                                            <p style="color: var(--color-gray-500); margin: var(--space-xs) 0; font-size: 0.813rem;">
                                                <strong>Reference:</strong> Legacy API Documentation Section 9
                                            </p>
                                        </div>

                                        <!-- Create Head Office Branch User -->
                                        <div style="padding: var(--space-md); border: 1px solid var(--color-gray-700); border-radius: 6px; background: rgba(255, 255, 255, 0.02);">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                                                <h4 style="margin: 0; color: var(--color-gray-200);">Create Head Office Branch User</h4>
                                                <span class="badge badge-warning">Blocked</span>
                                            </div>
                                            <p style="color: var(--color-gray-400); margin: var(--space-xs) 0; font-size: 0.875rem;">
                                                <strong>Method:</strong> PUT
                                            </p>
                                            <p style="color: var(--color-gray-400); margin: var(--space-xs) 0; font-size: 0.875rem;">
                                                <strong>Legacy Endpoint:</strong> <code>/headOffices/{head_office_member_id}/branches/{branch_id}/users</code>
                                            </p>
                                            <p style="color: var(--color-gray-400); margin: var(--space-xs) 0; font-size: 0.875rem;">
                                                <strong>Description:</strong> Create a new user for a specific branch
                                            </p>
                                            <p style="color: var(--color-gray-500); margin: var(--space-xs) 0; font-size: 0.813rem; font-style: italic;">
                                                <strong>Status:</strong> Awaiting Salesforce API implementation
                                            </p>
                                            <p style="color: var(--color-gray-500); margin: var(--space-xs) 0; font-size: 0.813rem;">
                                                <strong>Reference:</strong> Legacy API Documentation Section 10
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>

        <!-- Tab 2: Real-Time Activity -->
        <div id="real-time" class="tab-content">
            <div class="card glass">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                    <h3>Real-Time Activity</h3>
                    <button class="btn btn-secondary btn-sm" onclick="loadRecentRequests()">
                        Refresh
                    </button>
                </div>
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-requests-hour">--</div>
                            <div class="stat-label">Requests (Last Hour)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-success-rate">--</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-avg-response">--</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-active-orgs">--</div>
                            <div class="stat-label">Active Organizations</div>
                        </div>
                    </div>

                    <!-- Recent Requests Table -->
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                        <h3 style="margin: 0;">Recent Requests</h3>
                        <div class="page-size-controls">
                            <label class="page-size-label">Results per page:</label>
                            <select id="activity-results-per-page" onchange="changeActivityPageSize()" class="page-size-select">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="mapping-table" id="activity-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Organization</th>
                                    <th>Endpoint</th>
                                    <th>Status</th>
                                    <th>DAN</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-requests-table">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">
                                        Loading recent requests...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Controls -->
                    <div id="activity-pagination" class="pagination-controls">
                        <div class="pagination-info">
                            <span id="activity-showing-info">Showing 0 - 0 of 0 entries</span>
                        </div>
                        <div class="pagination-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="goToActivityPage(1)" id="activity-first-page">First</button>
                            <button class="btn btn-secondary btn-sm" onclick="previousActivityPage()" id="activity-prev-page">Previous</button>
                            <span class="pagination-current">
                                Page <span id="activity-current-page">1</span> of <span id="activity-total-pages">1</span>
                            </span>
                            <button class="btn btn-secondary btn-sm" onclick="nextActivityPage()" id="activity-next-page">Next</button>
                            <button class="btn btn-secondary btn-sm" onclick="goToActivityPage('last')" id="activity-last-page">Last</button>
                        </div>
                    </div>
            </div>
        </div>

        <!-- Tab 3: Organizations -->
        <div id="organizations" class="tab-content">
            <div class="card glass">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                    <h3>Organizations Using Legacy API</h3>
                    <button class="btn btn-secondary btn-sm" onclick="loadOrganizations()">
                        Refresh
                    </button>
                </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Organization Name</th>
                                    <th>Legacy Member ID</th>
                                    <th>Environment</th>
                                    <th>Requests Today</th>
                                    <th>Success Rate</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="organizations-table">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">
                                        Loading organizations...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
            </div>
        </div>

        <!-- Tab 4: Endpoint Coverage -->
        <div id="endpoints" class="tab-content">
            <div class="card glass">
                <h3>Endpoint Coverage</h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">Status of Legacy API endpoint implementations</p>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Legacy Endpoint</th>
                                    <th>Salesforce Endpoint</th>
                                    <th>Status</th>
                                    <th>Transformation</th>
                                    <th>Test Coverage</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>/CreateDeposit</code></td>
                                    <td><code>/services/apexrest/depositcreation</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Tested</td>
                                    <td>Fully operational</td>
                                </tr>
                                <tr>
                                    <td><code>/RaiseRepaymentRequest</code></td>
                                    <td><code>/services/apexrest/raiserepaymentrequest</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Ready for Testing</td>
                                    <td>Newly implemented</td>
                                </tr>
                                <tr>
                                    <td><code>/CreateDepositStatus/{batchId}</code></td>
                                    <td><code>/services/apexrest/CreateDepositStatus/{batchId}</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Tested</td>
                                    <td>Fully operational</td>
                                </tr>
                                <tr>
                                    <td><code>/TenancyInformation/{memberId}/{branchId}/{apiKey}/{dan}</code></td>
                                    <td><code>/services/apexrest/tenancyinformation/{dan}</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Tested</td>
                                    <td>Fully operational</td>
                                </tr>
                                <tr>
                                    <td><code>/DPC/{memberId}/{branchId}/{apiKey}/{dan}</code></td>
                                    <td><code>/services/apexrest/dpc/{dan}</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Ready for Testing</td>
                                    <td>Newly implemented</td>
                                </tr>
                                <tr>
                                    <td><code>/Landlords/{memberId}/{branchId}/{apiKey}?queryParams</code></td>
                                    <td><code>/services/apexrest/nonmemberlandlord</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Tested</td>
                                    <td>Fully operational</td>
                                </tr>
                                <tr>
                                    <td><code>/Properties/{memberId}/{branchId}/{apiKey}?queryParams</code></td>
                                    <td><code>/services/apexrest/property</code></td>
                                    <td><span class="badge badge-success">Implemented</span></td>
                                    <td><span class="badge badge-success">Complete</span></td>
                                    <td>Ready for Testing</td>
                                    <td>Newly implemented</td>
                                </tr>
                                <tr>
                                    <td><code>/UpdateTenancy</code></td>
                                    <td><code>/services/apexrest/tenancyupdate</code></td>
                                    <td><span class="badge badge-warning">Pending</span></td>
                                    <td><span class="badge badge-warning">Not Started</span></td>
                                    <td>Not Tested</td>
                                    <td>Awaiting implementation</td>
                                </tr>
                                <tr>
                                    <td><code>/ReleaseDeposit</code></td>
                                    <td><code>/services/apexrest/depositrelease</code></td>
                                    <td><span class="badge badge-warning">Pending</span></td>
                                    <td><span class="badge badge-warning">Not Started</span></td>
                                    <td>Not Tested</td>
                                    <td>Awaiting implementation</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-info" style="margin-top: var(--space-lg);">
                        <strong>Adding New Endpoints:</strong> To add a new Legacy endpoint, update the <code>LegacyAPIGateway.js</code> file with a new route handler and corresponding transformation logic in <code>legacy-to-salesforce.js</code>.
                    </div>
            </div>
        </div>

        <!-- Tab 5: Transformation Logs -->
        <div id="logs" class="tab-content">
            <div class="card glass">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                    <h3>Transformation Logs</h3>
                    <div style="display: flex; gap: var(--space-sm);">
                        <button class="btn btn-secondary btn-sm" onclick="loadTransformationLogs()">
                            Refresh
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="downloadLogs()">
                            Download CSV
                        </button>
                    </div>
                </div>
                    <!-- Filters -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div class="form-group">
                            <label class="form-label">Organization</label>
                            <select id="log-filter-org" class="form-select" onchange="applyLogFilters()">
                                <option value="">All Organizations</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Endpoint</label>
                            <select id="log-filter-endpoint" class="form-select" onchange="applyLogFilters()">
                                <option value="">All Endpoints</option>
                                <option value="CreateDeposit">CreateDeposit</option>
                                <option value="RaiseRepaymentRequest">RaiseRepaymentRequest</option>
                                <option value="CreateDepositStatus">CreateDepositStatus</option>
                                <option value="TenancyInformation">TenancyInformation</option>
                                <option value="DPC">DPC</option>
                                <option value="Landlords">Landlords</option>
                                <option value="Properties">Properties</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="log-filter-status" class="form-select" onchange="applyLogFilters()">
                                <option value="">All Statuses</option>
                                <option value="success">Success</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Organization</th>
                                    <th>Endpoint</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">
                                        Loading transformation logs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
            </div>
        </div>
    </div> <!-- End Container -->

    <!-- Footer -->
    <footer class="glass card" style="margin: 25px auto 20px auto; max-width: 1400px; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: var(--text-secondary); font-size: 13px;">
            © 2025 TDS RapidInt Platform
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <span id="userInfo" style="color: var(--text-secondary); font-size: 14px;"></span>
            <button class="btn btn-secondary" onclick="signOut()" id="signOutBtn" style="display:none; background: var(--glass-hover); color: var(--text-primary); border: 1px solid var(--glass-border); padding: 8px 16px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(20px); font-size: 13px;">
                Sign Out
            </button>
        </div>
    </footer>

    <script src="safe-render.js"></script>
    <script>
        // Configuration - from dashboard-config.js
        const API_BASE_URL = DASHBOARD_CONFIG.apiBaseUrl;
        const AUTH_METHOD = DASHBOARD_CONFIG.authMethod;

        // MSAL Configuration
        let msalInstance = null;
        let currentUser = null;

        /**
         * Helper function to run code when DOM is ready
         * Works both for initial page load and after redirects
         */
        function runWhenReady(callback) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                // DOM is already loaded, run immediately
                callback();
            }
        }

        if (AUTH_METHOD === 'entra-id') {
            const msalConfig = {
                auth: {
                    clientId: DASHBOARD_CONFIG.entraId.clientId,
                    authority: DASHBOARD_CONFIG.entraId.authority,
                    redirectUri: window.location.origin + window.location.pathname
                },
                cache: {
                    cacheLocation: 'localStorage',
                    storeAuthStateInCookie: false
                }
            };

            msalInstance = new msal.PublicClientApplication(msalConfig);

            // Handle redirect response
            msalInstance.handleRedirectPromise().then(response => {
                if (response) {
                    console.log('✅ Login successful:', response.account.username);
                    currentUser = response.account;
                }
                // Update user info if authenticated
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentUser = accounts[0];
                    document.getElementById('userInfo').textContent = `Welcome, ${currentUser.name || currentUser.username}`;
                    document.getElementById('signOutBtn').style.display = 'block';
                }
            }).catch(error => {
                console.error('❌ Authentication error:', error);
            });
        } else {
            // Function key mode (legacy)
            const FUNCTION_KEY = DASHBOARD_CONFIG.functionKey;
        }

        // Global state
        let organizations = [];
        let selectedOrg = null;

        /**
         * Get access token for API calls
         */
        async function getAccessToken() {
            if (AUTH_METHOD !== 'entra-id') {
                return null; // Function key mode
            }

            try {
                const accounts = msalInstance.getAllAccounts();

                if (accounts.length === 0) {
                    // No accounts, redirect to login
                    await msalInstance.loginRedirect({
                        scopes: [DASHBOARD_CONFIG.entraId.apiScope]
                    });
                    return null;
                }

                // Try to acquire token silently
                const silentRequest = {
                    scopes: [DASHBOARD_CONFIG.entraId.apiScope],
                    account: accounts[0]
                };

                const response = await msalInstance.acquireTokenSilent(silentRequest);
                return response.accessToken;
            } catch (error) {
                console.warn('Silent token acquisition failed, trying interactive:', error);

                if (error instanceof msal.InteractionRequiredAuthError) {
                    // Fallback to interactive login
                    await msalInstance.loginRedirect({
                        scopes: [DASHBOARD_CONFIG.entraId.apiScope]
                    });
                } else {
                    console.error('Token acquisition error:', error);
                    throw error;
                }

                return null;
            }
        }

        /**
         * Make authenticated API request
         */
        async function makeAuthenticatedRequest(url, options = {}) {
            if (AUTH_METHOD === 'entra-id') {
                // Entra ID mode - use Bearer token
                const token = await getAccessToken();

                if (!token) {
                    throw new Error('Failed to acquire access token');
                }

                return await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
            } else {
                // Function key mode (legacy)
                const separator = url.includes('?') ? '&' : '?';
                const authenticatedUrl = `${url}${separator}code=${DASHBOARD_CONFIG.functionKey}`;

                return await fetch(authenticatedUrl, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
            }
        }

        /**
         * Sign out user (Entra ID only)
         */
        async function signOut() {
            if (AUTH_METHOD === 'entra-id' && msalInstance) {
                await msalInstance.logoutRedirect();
            }
        }

        /**
         * Navigate back to Integration Hub
         */
        function goBackToHub() {
            window.location.href = 'multi-integration-dashboard.html';
        }

        /**
         * Initialize dashboard
         */
        async function init() {
            console.log('Initializing Legacy API Monitor...');
            await loadOrganizations();
            await checkGatewayHealth();
        }

        /**
         * Check Gateway Health
         */
        async function checkGatewayHealth() {
            const statusElement = document.getElementById('gatewayStatus');

            try {
                const response = await fetch(`${API_BASE_URL}/legacy/health`);
                const data = await response.json();

                if (data.status === 'healthy') {
                    statusElement.innerHTML = `
                        <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-success); display: inline-block;"></span>
                        <span>Gateway Active</span>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-error); display: inline-block;"></span>
                        <span>Gateway Error</span>
                    `;
                }
            } catch (error) {
                console.error('Failed to check gateway health:', error);
                statusElement.innerHTML = `
                    <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-error); display: inline-block;"></span>
                    <span>Gateway Offline</span>
                `;
            }
        }

        /**
         * Load Organizations
         */
        async function loadOrganizations() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/organization/list`);
                const data = await response.json();

                if (data.success) {
                    // Filter organizations with Legacy credentials
                    organizations = data.mappings.filter(org =>
                        org.legacyMemberId && org.legacyBranchId && org.isActive
                    );

                    // Populate organization dropdown
                    const selector = document.getElementById('org-selector');
                    selector.innerHTML = '<option value="">-- Select an organization --</option>';

                    organizations.forEach(org => {
                        const option = document.createElement('option');
                        // Use Legacy credentials as unique identifier (not agencyRef which is Alto-specific)
                        option.value = `${org.legacyMemberId}:${org.legacyBranchId}`;
                        option.textContent = `${org.organizationName} (${org.legacyMemberId}/${org.legacyBranchId})`;
                        selector.appendChild(option);
                    });

                    console.log(`Loaded ${organizations.length} organizations with Legacy credentials`);

                    // Populate organizations table
                    populateOrganizationsTable();
                }
            } catch (error) {
                console.error('Failed to load organizations:', error);
            }
        }

        /**
         * Populate Organizations Table
         */
        function populateOrganizationsTable() {
            const tbody = document.getElementById('organizations-table');
            tbody.innerHTML = '';

            if (organizations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">No organizations found with Legacy API credentials</td></tr>';
                return;
            }

            organizations.forEach(org => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${org.organizationName}</td>
                    <td><code>${org.legacyMemberId}</code></td>
                    <td><span class="badge badge-${org.environment === 'production' ? 'error' : 'info'}">${org.environment}</span></td>
                    <td>--</td>
                    <td>--</td>
                    <td><span class="badge badge-${org.isActive ? 'success' : 'warning'}">${org.isActive ? 'Active' : 'Inactive'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * On Organization Change
         */
        function onOrganizationChange() {
            const orgIdentifier = document.getElementById('org-selector').value;

            if (!orgIdentifier) {
                selectedOrg = null;
                return;
            }

            // Parse Legacy credentials from identifier (format: "memberId:branchId")
            const [memberId, branchId] = orgIdentifier.split(':');

            // Find organization by Legacy credentials (not agencyRef which is Alto-specific)
            selectedOrg = organizations.find(org =>
                org.legacyMemberId === memberId && org.legacyBranchId === branchId
            );

            if (selectedOrg) {
                console.log('Selected organization:', selectedOrg);
                // Organization selected - now you can use "Load Example" to populate with this org's credentials
            }
        }

        /**
         * Toggle Accordion
         */
        function toggleAccordion(headerElement) {
            const content = headerElement.nextElementSibling;
            const isActive = headerElement.classList.contains('active');

            // Close all accordions
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.classList.remove('active');
                header.nextElementSibling.classList.remove('active');
            });

            // Open clicked accordion (if it wasn't already open)
            if (!isActive) {
                headerElement.classList.add('active');
                content.classList.add('active');
            }
        }

        /**
         * Load Example Payload
         */
        function loadExamplePayload(endpoint) {
            if (!selectedOrg) {
                alert('Please select an organization first');
                return;
            }

            let examplePayload;

            if (endpoint === 'CreateDeposit') {
                examplePayload = {
                    member_id: selectedOrg.legacyMemberId,
                    branch_id: selectedOrg.legacyBranchId,
                    api_key: selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE',
                    region: 'EW',
                    scheme_type: 'Custodial',
                    tenancy: [{
                        user_tenancy_reference: 'TEST_TEN_' + Date.now(),
                        property_id: '12345',
                        property_paon: '123',
                        property_saon: 'Flat 4B',
                        property_street: 'Main Street',
                        property_town: 'London',
                        property_administrative_area: 'Greater London',
                        property_postcode: 'SW1A 1AA',
                        tenancy_start_date: '2025-10-15',
                        tenancy_expected_end_date: '2026-10-15',
                        number_of_bedrooms: 2,
                        number_of_living_rooms: 1,
                        furnished_status: 'furnished',
                        rent_amount: 1500.00,
                        deposit_amount: 1500.00,
                        deposit_amount_to_protect: 1500.00,
                        deposit_received_date: '2025-10-15',
                        number_of_tenants: 1,
                        number_of_landlords: 1,
                        people: [
                            {
                                person_classification: 'Lead Tenant',
                                person_title: 'Mr',
                                person_firstname: 'John',
                                person_surname: 'Doe',
                                person_email: 'john.doe@example.com',
                                person_mobile: '07700900123',
                                is_business: 'N'
                            },
                            {
                                person_classification: 'Primary Landlord',
                                person_title: 'Ms',
                                person_firstname: 'Jane',
                                person_surname: 'Smith',
                                person_email: 'jane.smith@example.com',
                                person_mobile: '07700900456',
                                person_paon: '456',
                                person_street: 'Oak Avenue',
                                person_town: 'London',
                                person_postcode: 'SW2A 2BB',
                                person_country: 'United Kingdom',
                                is_business: 'N'
                            }
                        ]
                    }]
                };

                document.getElementById('createdeposit-payload').value = JSON.stringify(examplePayload, null, 2);
            } else if (endpoint === 'RaiseRepaymentRequest') {
                examplePayload = {
                    api_key: selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE',
                    member_id: selectedOrg.legacyMemberId,
                    branch_id: selectedOrg.legacyBranchId,
                    dan: 'EW12345',
                    tenancy_end_date: '26/05/2020',
                    tenant_repayment_type: 'split',
                    tenant_repayment: 999.99,
                    agent_repayment: {
                        total: 454.48,
                        cleaning: 200,
                        rent_arrears: 0,
                        damage: 122.99,
                        redecoration: 0,
                        gardening: 32.49,
                        other: 99,
                        other_text: 'Description of other payment'
                    }
                };
                document.getElementById('raiserepaymentrequest-payload').value = JSON.stringify(examplePayload, null, 2);
            }
        }

        /**
         * Clear Payload
         */
        function clearPayload(endpoint) {
            if (endpoint === 'CreateDeposit') {
                document.getElementById('createdeposit-payload').value = '';
                document.getElementById('createdeposit-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('createdeposit-response-status').innerHTML = '';
                document.getElementById('createdeposit-response-time').innerHTML = '';
            } else if (endpoint === 'RaiseRepaymentRequest') {
                document.getElementById('raiserepaymentrequest-payload').value = '';
                document.getElementById('raiserepaymentrequest-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('raiserepaymentrequest-response-status').innerHTML = '';
                document.getElementById('raiserepaymentrequest-response-time').innerHTML = '';
            } else if (endpoint === 'CreateDepositStatus') {
                document.getElementById('batch-id-input').value = '';
                document.getElementById('createdepositstatus-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('createdepositstatus-response-status').innerHTML = '';
                document.getElementById('createdepositstatus-response-time').innerHTML = '';
            } else if (endpoint === 'TenancyInformation') {
                document.getElementById('dan-input').value = '';
                document.getElementById('tenancyinformation-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('tenancyinformation-response-status').innerHTML = '';
                document.getElementById('tenancyinformation-response-time').innerHTML = '';
            } else if (endpoint === 'DPC') {
                document.getElementById('dpc-dan-input').value = '';
                document.getElementById('dpc-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('dpc-response-status').innerHTML = '';
                document.getElementById('dpc-response-time').innerHTML = '';
            } else if (endpoint === 'Landlords') {
                document.getElementById('landlord-id-input').value = '';
                document.getElementById('landlord-email-input').value = '';
                document.getElementById('landlord-limit-input').value = '50';
                document.getElementById('landlord-after-id-input').value = '';
                document.getElementById('landlords-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('landlords-response-status').innerHTML = '';
                document.getElementById('landlords-response-time').innerHTML = '';
            } else if (endpoint === 'Properties') {
                document.getElementById('property-id-input').value = '';
                document.getElementById('property-postcode-input').value = '';
                document.getElementById('property-limit-input').value = '50';
                document.getElementById('property-after-id-input').value = '';
                document.getElementById('properties-response').innerHTML = '<div class="empty-response">Response will appear here after execution</div>';
                document.getElementById('properties-response-status').innerHTML = '';
                document.getElementById('properties-response-time').innerHTML = '';
            }
        }

        /**
         * Execute Endpoint
         */
        async function executeEndpoint(endpoint) {
            try {
                if (endpoint === 'CreateDeposit') {
                    await executeCreateDeposit();
                } else if (endpoint === 'RaiseRepaymentRequest') {
                    await executeRaiseRepaymentRequest();
                } else if (endpoint === 'CreateDepositStatus') {
                    await executeCreateDepositStatus();
                } else if (endpoint === 'TenancyInformation') {
                    await executeTenancyInformation();
                } else if (endpoint === 'DPC') {
                    await executeDPC();
                } else if (endpoint === 'Landlords') {
                    await executeLandlords();
                } else if (endpoint === 'Properties') {
                    await executeProperties();
                }
            } catch (error) {
                console.error('Execution failed:', error);
                alert(`Execution failed: ${error.message}`);
            }
        }

        /**
         * Execute CreateDeposit
         */
        async function executeCreateDeposit() {
            const payloadText = document.getElementById('createdeposit-payload').value;

            if (!payloadText.trim()) {
                alert('Please enter a payload or load an example');
                return;
            }

            let payload;
            try {
                payload = JSON.parse(payloadText);
            } catch (e) {
                alert('Invalid JSON payload');
                return;
            }

            // Validate required credentials are present in the payload
            if (!payload.member_id || !payload.branch_id || !payload.api_key) {
                alert('Payload must include member_id, branch_id, and api_key');
                return;
            }

            // Show loading state
            document.getElementById('createdeposit-response').innerHTML = '<div class="empty-response">Executing request...</div>';
            document.getElementById('createdeposit-response-status').innerHTML = '';
            document.getElementById('createdeposit-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                const response = await fetch(`${API_BASE_URL}/legacy/CreateDeposit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                // Check for error conditions:
                // 1. HTTP error status code (4xx, 5xx)
                // 2. Legacy API error format: success === "false" or false
                // 3. Legacy API error format: errors array present
                // 4. Old error format: data.error field
                const isError = !response.ok ||
                               data.success === "false" ||
                               data.success === false ||
                               data.status === 'Failed' ||
                               (data.errors && data.errors.length > 0) ||
                               data.error;

                const statusElement = document.getElementById('createdeposit-response-status');
                statusElement.className = `response-status ${isError ? 'error' : 'success'}`;
                statusElement.textContent = isError ? 'Error' : 'Success';

                document.getElementById('createdeposit-response-time').textContent = `${duration}ms`;

                document.getElementById('createdeposit-response').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('createdeposit-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('createdeposit-response-time').textContent = `${duration}ms`;
                document.getElementById('createdeposit-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Execute RaiseRepaymentRequest
         */
        async function executeRaiseRepaymentRequest() {
            const payloadText = document.getElementById('raiserepaymentrequest-payload').value;

            if (!payloadText.trim()) {
                alert('Please enter a payload or load an example');
                return;
            }

            let payload;
            try {
                payload = JSON.parse(payloadText);
            } catch (e) {
                alert('Invalid JSON payload: ' + e.message);
                return;
            }

            // Show loading state
            document.getElementById('raiserepaymentrequest-response').innerHTML = '<div class="empty-response">Submitting repayment request...</div>';
            document.getElementById('raiserepaymentrequest-response-status').innerHTML = '';
            document.getElementById('raiserepaymentrequest-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                const response = await fetch(`${API_BASE_URL}/legacy/RaiseRepaymentRequest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                const isError = !response.ok ||
                               data.success === "false" ||
                               data.success === false ||
                               (data.errors && Object.keys(data.errors).length > 0);

                const statusElement = document.getElementById('raiserepaymentrequest-response-status');
                statusElement.className = `response-status ${isError ? 'error' : 'success'}`;
                statusElement.textContent = isError ? 'Error' : 'Success';

                document.getElementById('raiserepaymentrequest-response-time').textContent = `${duration}ms`;

                document.getElementById('raiserepaymentrequest-response').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('raiserepaymentrequest-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('raiserepaymentrequest-response-time').textContent = `${duration}ms`;
                document.getElementById('raiserepaymentrequest-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Execute CreateDepositStatus
         */
        async function executeCreateDepositStatus() {
            const batchId = document.getElementById('batch-id-input').value.trim();

            if (!batchId) {
                alert('Please enter a batch ID');
                return;
            }

            if (!selectedOrg) {
                alert('Please select an organization to check deposit status');
                return;
            }

            // Show loading state
            document.getElementById('createdepositstatus-response').innerHTML = '<div class="empty-response">Checking status...</div>';
            document.getElementById('createdepositstatus-response-status').innerHTML = '';
            document.getElementById('createdepositstatus-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                // Construct Legacy API URL format: GET /CreateDepositStatus/{memberId}/{branchId}/{apiKey}/{batchId}
                const memberId = selectedOrg.legacyMemberId;
                const branchId = selectedOrg.legacyBranchId;
                const apiKey = selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE';

                const url = `${API_BASE_URL}/legacy/CreateDepositStatus/${memberId}/${branchId}/${apiKey}/${batchId}`;

                const response = await fetch(url, {
                    method: 'GET'
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                // Check for error conditions:
                // 1. HTTP error status code (4xx, 5xx)
                // 2. Legacy API error format: success === true && status === "Failed"
                // 3. Legacy API error format: errors array present
                // 4. Old error format: data.error field
                const isError = !response.ok ||
                               data.status === 'Failed' ||
                               (data.errors && data.errors.length > 0) ||
                               data.error ||
                               data.success === "false" ||
                               data.success === false;

                const statusElement = document.getElementById('createdepositstatus-response-status');
                statusElement.className = `response-status ${isError ? 'error' : 'success'}`;
                statusElement.textContent = isError ? 'Error' : 'Success';

                document.getElementById('createdepositstatus-response-time').textContent = `${duration}ms`;

                document.getElementById('createdepositstatus-response').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('createdepositstatus-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('createdepositstatus-response-time').textContent = `${duration}ms`;
                document.getElementById('createdepositstatus-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Execute TenancyInformation
         */
        async function executeTenancyInformation() {
            const dan = document.getElementById('dan-input').value.trim();

            if (!dan) {
                alert('Please enter a DAN (Deposit Account Number)');
                return;
            }

            if (!selectedOrg) {
                alert('Please select an organization to query tenancy information');
                return;
            }

            // Show loading state
            document.getElementById('tenancyinformation-response').innerHTML = '<div class="empty-response">Fetching tenancy information...</div>';
            document.getElementById('tenancyinformation-response-status').innerHTML = '';
            document.getElementById('tenancyinformation-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                // Construct Legacy API URL format: GET /TenancyInformation/{memberId}/{branchId}/{apiKey}/{dan}
                const memberId = selectedOrg.legacyMemberId;
                const branchId = selectedOrg.legacyBranchId;
                const apiKey = selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE';

                const url = `${API_BASE_URL}/legacy/TenancyInformation/${memberId}/${branchId}/${apiKey}/${dan}`;

                const response = await fetch(url, {
                    method: 'GET'
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                // Check for error conditions:
                // 1. HTTP error status code (4xx, 5xx)
                // 2. Legacy API error format: success === "false" or false
                // 3. Legacy API error format: errors array present
                const isError = !response.ok ||
                               data.success === "false" ||
                               data.success === false ||
                               (data.errors && data.errors.length > 0);

                const statusElement = document.getElementById('tenancyinformation-response-status');
                statusElement.className = `response-status ${isError ? 'error' : 'success'}`;
                statusElement.textContent = isError ? 'Error' : 'Success';

                document.getElementById('tenancyinformation-response-time').textContent = `${duration}ms`;

                document.getElementById('tenancyinformation-response').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('tenancyinformation-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('tenancyinformation-response-time').textContent = `${duration}ms`;
                document.getElementById('tenancyinformation-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Execute DPC (Deposit Protection Certificate)
         */
        async function executeDPC() {
            const dan = document.getElementById('dpc-dan-input').value.trim();

            if (!dan) {
                alert('Please enter a DAN (Deposit Account Number)');
                return;
            }

            if (!selectedOrg) {
                alert('Please select an organization to retrieve DPC certificate');
                return;
            }

            // Show loading state
            document.getElementById('dpc-response').innerHTML = '<div class="empty-response">Fetching DPC certificate...</div>';
            document.getElementById('dpc-response-status').innerHTML = '';
            document.getElementById('dpc-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                // Construct Legacy API URL format: GET /DPC/{memberId}/{branchId}/{apiKey}/{dan}
                const memberId = selectedOrg.legacyMemberId;
                const branchId = selectedOrg.legacyBranchId;
                const apiKey = selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE';

                const url = `${API_BASE_URL}/legacy/DPC/${memberId}/${branchId}/${apiKey}/${dan}`;

                const response = await fetch(url, {
                    method: 'GET'
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                const isError = !response.ok ||
                               data.success === "false" ||
                               data.success === false ||
                               (data.errors && data.errors.length > 0);

                const statusElement = document.getElementById('dpc-response-status');
                statusElement.className = `response-status ${isError ? 'error' : 'success'}`;
                statusElement.textContent = isError ? 'Error' : 'Success';

                document.getElementById('dpc-response-time').textContent = `${duration}ms`;

                // If successful and certificate URL is present, make it clickable
                let displayData = data;
                if (data.certificate && data.success) {
                    displayData = {
                        ...data,
                        _note: 'Click the certificate URL below to download the PDF'
                    };
                }

                document.getElementById('dpc-response').innerHTML = `<pre>${JSON.stringify(displayData, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('dpc-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('dpc-response-time').textContent = `${duration}ms`;
                document.getElementById('dpc-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Execute Landlords Search
         */
        async function executeLandlords() {
            const landlordId = document.getElementById('landlord-id-input').value.trim();
            const email = document.getElementById('landlord-email-input').value.trim();
            const limit = document.getElementById('landlord-limit-input').value.trim();
            const afterId = document.getElementById('landlord-after-id-input').value.trim();

            if (!selectedOrg) {
                alert('Please select an organization to search landlords');
                return;
            }

            // Show loading state
            document.getElementById('landlords-response').innerHTML = '<div class="empty-response">Searching landlords...</div>';
            document.getElementById('landlords-response-status').innerHTML = '';
            document.getElementById('landlords-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                // Construct Legacy API URL format: GET /Landlords/{memberId}/{branchId}/{apiKey}?queryParams
                const memberId = selectedOrg.legacyMemberId;
                const branchId = selectedOrg.legacyBranchId;
                const apiKey = selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE';

                // Build query string
                const queryParams = new URLSearchParams();
                if (landlordId) queryParams.append('id', landlordId);
                if (email) queryParams.append('email', email);
                if (limit) queryParams.append('limit', limit);
                if (afterId) queryParams.append('after_id', afterId);

                const queryString = queryParams.toString();
                const url = `${API_BASE_URL}/legacy/Landlords/${memberId}/${branchId}/${apiKey}${queryString ? '?' + queryString : ''}`;

                const response = await fetch(url, {
                    method: 'GET'
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                // Check for error conditions:
                // 1. HTTP error status code (4xx, 5xx)
                // 2. Legacy API error format: success === false
                // 3. Legacy API error format: errors array present
                const isError = !response.ok ||
                               data.success === false ||
                               (data.errors && data.errors.length > 0);

                const statusElement = document.getElementById('landlords-response-status');
                statusElement.className = `response-status ${isError ? 'error' : 'success'}`;
                statusElement.textContent = isError ? 'Error' : 'Success';

                document.getElementById('landlords-response-time').textContent = `${duration}ms`;

                // Format response with count
                let displayData = data;
                if (data.landlords && data.totalResults !== undefined) {
                    displayData = {
                        ...data,
                        _summary: `Found ${data.totalResults} landlord(s)`
                    };
                }

                document.getElementById('landlords-response').innerHTML = `<pre>${JSON.stringify(displayData, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('landlords-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('landlords-response-time').textContent = `${duration}ms`;
                document.getElementById('landlords-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Execute Properties Search
         */
        async function executeProperties() {
            const propertyId = document.getElementById('property-id-input').value.trim();
            const postcode = document.getElementById('property-postcode-input').value.trim();
            const limit = document.getElementById('property-limit-input').value.trim();
            const afterId = document.getElementById('property-after-id-input').value.trim();

            if (!selectedOrg) {
                alert('Please select an organization to search properties');
                return;
            }

            // Show loading state
            document.getElementById('properties-response').innerHTML = '<div class="empty-response">Searching properties...</div>';
            document.getElementById('properties-response-status').innerHTML = '';
            document.getElementById('properties-response-time').innerHTML = '';

            const startTime = Date.now();

            try {
                // Construct Legacy API URL format: GET /Properties/{memberId}/{branchId}/{apiKey}?queryParams
                const memberId = selectedOrg.legacyMemberId;
                const branchId = selectedOrg.legacyBranchId;
                const apiKey = selectedOrg.legacyApiKey || 'YOUR_API_KEY_HERE';

                // Build query string
                const queryParams = new URLSearchParams();
                if (propertyId) queryParams.append('id', propertyId);
                if (postcode) queryParams.append('postcode', postcode);
                if (limit) queryParams.append('limit', limit);
                if (afterId) queryParams.append('after_id', afterId);

                const queryString = queryParams.toString();
                const url = `${API_BASE_URL}/legacy/Properties/${memberId}/${branchId}/${apiKey}${queryString ? '?' + queryString : ''}`;

                const response = await fetch(url, {
                    method: 'GET'
                });

                const duration = Date.now() - startTime;
                const data = await response.json();

                // Display response
                // Check for error conditions:
                // 1. HTTP error status code (4xx, 5xx)
                // 2. Legacy API error format: success === false
                // 3. Legacy API error format: errors array present
                const isError = !response.ok ||
                               data.success === false ||
                               (data.errors && data.errors.length > 0);

                const statusElement = document.getElementById('properties-response-status');
                statusElement.className = `response-status ${isError ? 'error' : 'success'}`;
                statusElement.textContent = isError ? 'Error' : 'Success';

                document.getElementById('properties-response-time').textContent = `${duration}ms`;

                // Format response with count
                let displayData = data;
                if (data.properties && data.totalResults !== undefined) {
                    displayData = {
                        ...data,
                        _summary: `Found ${data.totalResults} propert${data.totalResults === 1 ? 'y' : 'ies'}`
                    };
                }

                document.getElementById('properties-response').innerHTML = `<pre>${JSON.stringify(displayData, null, 2)}</pre>`;

            } catch (error) {
                const duration = Date.now() - startTime;

                document.getElementById('properties-response-status').innerHTML = '<span class="response-status error">Error</span>';
                document.getElementById('properties-response-time').textContent = `${duration}ms`;
                document.getElementById('properties-response').innerHTML = `<pre>${JSON.stringify({ error: error.message }, null, 2)}</pre>`;
            }
        }

        /**
         * Tab Switching
         */
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('tab-content-active'));

            // Highlight the clicked tab
            if (typeof event !== 'undefined' && event && event.target && event.target.classList.contains('tab')) {
                // Normal tab click - highlight the clicked tab
                event.target.classList.add('tab-active');
            } else {
                // Programmatic tab switching - find and highlight the correct tab
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.getAttribute('onclick') === `showTab('${tabName}')`) {
                        tab.classList.add('tab-active');
                    }
                });
            }

            // Show the selected tab content
            document.getElementById(tabName).classList.add('tab-content-active');

            // Load data for specific tabs
            if (tabName === 'real-time') {
                loadRecentRequests();
            } else if (tabName === 'logs') {
                loadTransformationLogs();
            }
        }

        /**
         * Pagination state for activity log
         */
        let activityCurrentPage = 1;
        let activityPageSize = 10;
        let activityTotalEntries = 0;
        let currentActivityData = []; // Store full activity data for pagination

        /**
         * Load Recent Requests
         */
        async function loadRecentRequests() {
            const tbody = document.getElementById('recent-requests-table');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">Loading recent requests...</td></tr>';

            try {
                const response = await fetch(`${API_BASE_URL}/legacy/activity`);
                const data = await response.json();

                if (data.success) {
                    // Update stats
                    document.getElementById('stat-requests-hour').textContent = data.stats.requestsLastHour;
                    document.getElementById('stat-success-rate').textContent = data.stats.successRate;
                    document.getElementById('stat-avg-response').textContent = data.stats.avgResponseTime;
                    document.getElementById('stat-active-orgs').textContent = data.stats.activeOrgs;

                    // Store data and reset pagination
                    currentActivityData = data.batches;
                    activityTotalEntries = data.batches.length;
                    activityCurrentPage = 1;

                    // Display paginated results
                    displayActivityData();
                } else {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--color-error); padding: var(--space-xl);">Error loading activity: ${data.error}</td></tr>`;
                }
            } catch (error) {
                console.error('Failed to load recent requests:', error);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--color-error); padding: var(--space-xl);">Failed to load activity</td></tr>`;

                // Set default stats
                document.getElementById('stat-requests-hour').textContent = '--';
                document.getElementById('stat-success-rate').textContent = '--';
                document.getElementById('stat-avg-response').textContent = '--';
                document.getElementById('stat-active-orgs').textContent = organizations.length;
            }
        }

        /**
         * Display Activity Data (with pagination)
         */
        function displayActivityData() {
            const tbody = document.getElementById('recent-requests-table');

            if (!currentActivityData || currentActivityData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">No recent requests found</td></tr>';
                updateActivityPaginationUI(1, 0, 0);
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(activityTotalEntries / activityPageSize) || 1;

            // Ensure current page is valid
            if (activityCurrentPage > totalPages) {
                activityCurrentPage = totalPages;
            }

            const startIndex = (activityCurrentPage - 1) * activityPageSize;
            const endIndex = Math.min(startIndex + activityPageSize, activityTotalEntries);
            const pageEntries = currentActivityData.slice(startIndex, endIndex);

            tbody.innerHTML = '';

            // ✅ XSS Protection: Build table rows using safe DOM methods
            pageEntries.forEach(batch => {
                const row = document.createElement('tr');

                // Determine status from audit log success field
                const status = batch.success ? 'success' : 'failed';

                // Apply row status class
                if (status === 'success') {
                    row.className = 'success-row';
                } else if (status === 'pending') {
                    row.className = 'pending-row';
                } else {
                    row.className = 'error-row';
                }

                // Timestamp cell
                row.appendChild(safeCreateElement('td', formatDateTime(batch.createdAt)));

                // Organization cell
                row.appendChild(safeCreateElement('td', batch.organizationName || 'Unknown'));

                // Endpoint cell
                const endpoint = batch.endpoint || 'CreateDeposit';
                const endpointCell = document.createElement('td');
                const endpointCode = safeCreateElement('code', endpoint);
                endpointCell.appendChild(endpointCode);
                row.appendChild(endpointCell);

                // Status badge cell
                const statusCell = document.createElement('td');
                const statusBadge = safeCreateElement('span', status, {
                    className: `status-badge ${status.toLowerCase()}`
                });
                statusCell.appendChild(statusBadge);
                row.appendChild(statusCell);

                // DAN cell
                row.appendChild(safeCreateElement('td', batch.danNumber || '-'));

                // Duration cell
                const duration = batch.requestDurationMs ? `${batch.requestDurationMs}ms` : '--';
                row.appendChild(safeCreateElement('td', duration));

                // Actions cell with view button
                const actionsCell = document.createElement('td');
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-secondary btn-sm';
                viewBtn.textContent = 'View';
                viewBtn.onclick = () => viewBatchDetails(batch.requestId, batch.organizationId);
                actionsCell.appendChild(viewBtn);
                row.appendChild(actionsCell);

                tbody.appendChild(row);
            });

            // Update pagination UI
            updateActivityPaginationUI(totalPages, startIndex, endIndex);
        }

        /**
         * Update Activity Pagination UI
         */
        function updateActivityPaginationUI(totalPages, startIndex, endIndex) {
            document.getElementById('activity-current-page').textContent = activityCurrentPage;
            document.getElementById('activity-total-pages').textContent = totalPages;
            document.getElementById('activity-showing-info').textContent =
                `Showing ${startIndex + 1} - ${endIndex} of ${activityTotalEntries} entries`;

            // Enable/disable pagination buttons
            document.getElementById('activity-first-page').disabled = activityCurrentPage === 1;
            document.getElementById('activity-prev-page').disabled = activityCurrentPage === 1;
            document.getElementById('activity-next-page').disabled = activityCurrentPage === totalPages;
            document.getElementById('activity-last-page').disabled = activityCurrentPage === totalPages;
        }

        /**
         * Change Activity Page Size
         */
        function changeActivityPageSize() {
            activityPageSize = parseInt(document.getElementById('activity-results-per-page').value);
            activityCurrentPage = 1; // Reset to first page
            displayActivityData();
        }

        /**
         * Go to Activity Page
         */
        function goToActivityPage(page) {
            const totalPages = Math.ceil(activityTotalEntries / activityPageSize) || 1;

            if (page === 'last') {
                activityCurrentPage = totalPages;
            } else if (typeof page === 'number') {
                activityCurrentPage = Math.max(1, Math.min(page, totalPages));
            }

            displayActivityData();
        }

        /**
         * Previous Activity Page
         */
        function previousActivityPage() {
            if (activityCurrentPage > 1) {
                activityCurrentPage--;
                displayActivityData();
            }
        }

        /**
         * Next Activity Page
         */
        function nextActivityPage() {
            const totalPages = Math.ceil(activityTotalEntries / activityPageSize) || 1;
            if (activityCurrentPage < totalPages) {
                activityCurrentPage++;
                displayActivityData();
            }
        }

        /**
         * View Batch Details - Fetch and display audit log details in modal
         */
        async function viewBatchDetails(requestId, organizationId) {
            if (!requestId) {
                console.error('No requestId provided');
                return;
            }

            try {
                // Fetch audit log details from backend
                const response = await fetch(`${API_BASE_URL}/legacy/audit/${requestId}`);
                const result = await response.json();

                if (!result.success) {
                    console.error('Failed to fetch audit log details:', result.error);
                    alert(`Failed to fetch details: ${result.error}`);
                    return;
                }

                const log = result.log;

                // ✅ XSS Protection: Build modal using safe DOM methods
                const modal = document.createElement('div');
                modal.className = 'audit-modal';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                const modalContent = document.createElement('div');
                modalContent.className = 'audit-modal-content';

                // Header
                const header = document.createElement('div');
                header.className = 'audit-modal-header';
                const title = document.createElement('h3');
                title.textContent = `Request Details - ${log.endpoint}`;
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-modal';
                closeBtn.textContent = '×';
                closeBtn.onclick = () => modal.remove();
                header.appendChild(title);
                header.appendChild(closeBtn);
                modalContent.appendChild(header);

                // Body
                const body = document.createElement('div');
                body.className = 'audit-modal-body';

                // Detail Grid
                const detailGrid = document.createElement('div');
                detailGrid.className = 'audit-detail-grid';

                // Helper to create detail row
                const addDetail = (label, value, fullWidth = false) => {
                    const div = document.createElement('div');
                    if (fullWidth) div.style.gridColumn = '1 / -1';
                    const strong = document.createElement('strong');
                    strong.textContent = label + ': ';
                    div.appendChild(strong);
                    div.appendChild(safeCreateElement('span', value || '-'));
                    detailGrid.appendChild(div);
                };

                // Add details
                addDetail('Timestamp', new Date(log.timestamp).toLocaleString());

                // Status badge
                const statusDiv = document.createElement('div');
                const statusLabel = document.createElement('strong');
                statusLabel.textContent = 'Status: ';
                statusDiv.appendChild(statusLabel);
                const statusBadge = safeCreateElement('span', log.success ? 'Success' : 'Failed', {
                    className: `status-badge ${log.success ? 'success' : 'error'}`
                });
                statusDiv.appendChild(statusBadge);
                detailGrid.appendChild(statusDiv);

                addDetail('Organization', log.organizationName);
                addDetail('Endpoint', log.endpoint);
                addDetail('Method', log.method);
                addDetail('Response Status', log.responseStatus);
                addDetail('Response Time', log.responseTime ? `${log.responseTime}ms` : '-');
                addDetail('Request ID', log.requestId);

                // Metadata
                if (log.metadata) {
                    if (log.metadata.batchId) addDetail('Batch ID', log.metadata.batchId);
                    if (log.metadata.danNumber) addDetail('DAN', log.metadata.danNumber);
                    if (log.metadata.legacyMemberId) addDetail('Legacy Member ID', log.metadata.legacyMemberId);
                    if (log.metadata.legacyBranchId) addDetail('Legacy Branch ID', log.metadata.legacyBranchId);
                }

                // Request URL
                addDetail('Request URL', log.requestUrl, true);

                // Error message
                if (log.errorMessage) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.gridColumn = '1 / -1';
                    errorDiv.className = 'error-detail';
                    const errorLabel = document.createElement('strong');
                    errorLabel.textContent = 'Error: ';
                    errorDiv.appendChild(errorLabel);
                    errorDiv.appendChild(safeCreateElement('span', log.errorMessage));
                    detailGrid.appendChild(errorDiv);
                }

                body.appendChild(detailGrid);

                // Request Body section
                if (log.requestBody) {
                    const requestSection = document.createElement('div');
                    requestSection.className = 'full-result';
                    const requestTitle = document.createElement('h4');
                    requestTitle.textContent = 'Request Body:';
                    requestSection.appendChild(requestTitle);

                    const requestPre = document.createElement('pre');
                    requestPre.textContent = JSON.stringify(log.requestBody, null, 2);
                    requestSection.appendChild(requestPre);
                    body.appendChild(requestSection);
                }

                // Response Body section
                if (log.responseBody) {
                    const responseSection = document.createElement('div');
                    responseSection.className = 'full-result';
                    const responseTitle = document.createElement('h4');
                    responseTitle.textContent = 'Response Body:';
                    responseSection.appendChild(responseTitle);

                    const responsePre = document.createElement('pre');

                    // Check if response was truncated
                    if (log.responseBody._truncated) {
                        responsePre.textContent = `Response too large to store (${log.responseBody._originalSize} bytes)`;
                        if (log.responseBody._recordCount) {
                            responsePre.textContent += `\nRecord Count: ${log.responseBody._recordCount}`;
                        }
                        if (log.responseBody._preview) {
                            responsePre.textContent += `\n\nPreview:\n${log.responseBody._preview}`;
                        }
                    } else {
                        responsePre.textContent = JSON.stringify(log.responseBody, null, 2);
                    }

                    responseSection.appendChild(responsePre);
                    body.appendChild(responseSection);
                }

                modalContent.appendChild(body);
                modal.appendChild(modalContent);
                document.body.appendChild(modal);

            } catch (error) {
                console.error('Failed to load batch details:', error);
                alert(`Failed to load details: ${error.message}`);
            }
        }

        /**
         * Load Transformation Logs (Placeholder)
         */
        function loadTransformationLogs() {
            const tbody = document.getElementById('logs-table');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-gray-400); padding: var(--space-xl);">No transformation logs available</td></tr>';
        }

        /**
         * Apply Log Filters (Placeholder)
         */
        function applyLogFilters() {
            console.log('Applying log filters...');
            loadTransformationLogs();
        }

        /**
         * Download Logs (Placeholder)
         */
        function downloadLogs() {
            alert('CSV download functionality coming soon');
        }

        // Initialize on page load
        runWhenReady(init);
    </script>
</body>
</html>
